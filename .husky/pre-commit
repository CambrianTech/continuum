# Run TypeScript compilation check first (fastest failure)
echo "ğŸ” Checking TypeScript compilation..."
npx tsc --noEmit --project . || {
    echo "âš ï¸  TypeScript compilation has errors. Consider fixing them."
    # Don't block commit for now - we're in active development
}

# Gradual ESLint enforcement - add directories as they're cleaned up
echo "ğŸ” Running ESLint checks on clean directories..."

# List of directories that must pass ESLint
CLEAN_DIRS=(
  "src/daemons/base"                # Core daemon infrastructure âœ…
  "src/daemons/daemon-manager"      # Master daemon controller âœ…
  "src/daemons/mesh-coordinator"    # Mesh coordination daemon âœ…
  "src/commands/core/base-command"  # BaseCommand infrastructure âœ…
  # "src/daemons/static-file"      # TODO: 8 issues
  # "src/daemons/mesh"             # TODO: 12 issues
  # "src/daemons/renderer"         # TODO: 13 issues
  # "src/test/integration"         # TODO: 50 issues (imports with .js extensions)
  # "src/types"                    # TODO: 37 issues (any types)
  # "src/commands"                 # TODO: Add after fixing all command 'any' types
  # "src/daemons"                  # TODO: Add after fixing 605 issues
  # "src/integrations"             # TODO: Add after daemons are clean
  # "src/ui"                       # TODO: Add after core is clean
)

# Run ESLint on each clean directory
for dir in "${CLEAN_DIRS[@]}"; do
  echo "  âœ“ Checking $dir..."
  npx eslint "$dir" --ext .ts,.js || {
    echo "âŒ ESLint found errors in $dir! Fix them before committing."
    echo "ğŸ’¡ Run 'npx eslint $dir --ext .ts,.js' to see detailed errors"
    exit 1
  }
done

echo "âœ… ESLint checks passed for clean directories"

# Run critical integration tests
echo "ğŸ§ª Running core integration tests..."

# Run event bus test (critical for daemon communication)
npm run test:integration:eventbus || {
    echo "âŒ Event bus tests failed! Fix failing tests before committing."
    exit 1
}

# Run module structure test (ensures all daemons are properly configured)
npm run test:integration:modules || {
    echo "âŒ Module structure tests failed! Fix failing tests before committing."
    exit 1
}

# Run type safety test (ensures no 'any' types)
npm run test:integration:types || {
    echo "âŒ Type safety tests failed! Fix failing tests before committing."
    exit 1
}

echo "âœ… Core tests passed! Proceeding with commit..."