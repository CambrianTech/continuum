/**
 * User Profile Entity - Display and presentation data for users
 *
 * Separates UI/display concerns from core UserEntity system functionality
 * Handles visual identity, bio, speciality, and user preferences
 * Supports three-tier citizen architecture: humans, agents, personas
 */

import type { UUID } from '../../core/types/CrossPlatformUUID';

// User profile types for three-tier citizen architecture
export type UserSpecialityType = 'general' | 'code' | 'planning' | 'analysis' | 'creative' | 'teaching';

export interface UserVisualIdentity {
  avatar: string;
  theme: 'light' | 'dark' | 'auto';
  accentColor: string;
  badge?: string; // For agents/personas: shows their speciality
}

export interface UserPreferences {
  language: string;
  timezone: string;
  notifications: {
    mentions: boolean;
    directMessages: boolean;
    roomUpdates: boolean;
  };
  privacy: {
    showOnlineStatus: boolean;
    allowDirectMessages: boolean;
    shareActivity: boolean;
  };
}

import {
  PrimaryField,
  TextField,
  DateField,
  EnumField,
  JsonField,
  ForeignKeyField,
  TEXT_LENGTH
} from '../decorators/FieldDecorators';
import { BaseEntity } from './BaseEntity';

/**
 * User Profile Entity - Handles display/presentation data
 *
 * Complements UserEntity (core system functionality) with:
 * - Visual identity (avatar, theme, colors)
 * - Biographical information (bio, location, speciality)
 * - User preferences (notifications, privacy)
 * - Joined/activity metadata
 */
export class UserProfileEntity extends BaseEntity {
  static readonly collection = 'UserProfile';

  @ForeignKeyField({ references: 'users.id', index: true })
  userId: UUID;

  @TextField({ nullable: true, maxLength: TEXT_LENGTH.MEDIUM })
  bio?: string;

  @TextField({ nullable: true, maxLength: TEXT_LENGTH.SHORT })
  location?: string;

  @EnumField({ nullable: true })
  speciality?: UserSpecialityType;

  @DateField({ index: true })
  joinedAt: Date;

  // Complex display objects stored as JSON blobs
  @JsonField()
  visualIdentity: UserVisualIdentity;

  @JsonField()
  preferences: UserPreferences;

  constructor() {
    super(); // Initialize BaseEntity fields (id, createdAt, updatedAt, version)

    // Default values - id autogenerated by BaseEntity
    this.userId = '' as UUID;
    this.joinedAt = new Date();
    this.visualIdentity = {
      avatar: '',
      theme: 'auto',
      accentColor: '#4A90E2'
    };
    this.preferences = {
      language: 'en',
      timezone: 'UTC',
      notifications: {
        mentions: true,
        directMessages: true,
        roomUpdates: false
      },
      privacy: {
        showOnlineStatus: true,
        allowDirectMessages: true,
        shareActivity: false
      }
    };
  }

  /**
   * Implement BaseEntity abstract method
   */
  get collection(): string {
    return UserProfileEntity.collection;
  }

  /**
   * Implement BaseEntity abstract method - validate profile data
   */
  validate(): { success: boolean; error?: string } {
    // Required fields validation
    if (!this.userId?.trim()) {
      return { success: false, error: 'UserProfile userId is required' };
    }

    // Enum validation for speciality
    if (this.speciality) {
      const validSpecialities: UserSpecialityType[] = ['general', 'code', 'planning', 'analysis', 'creative', 'teaching'];
      if (!validSpecialities.includes(this.speciality)) {
        return { success: false, error: `UserProfile speciality must be one of: ${validSpecialities.join(', ')}` };
      }
    }

    // Date validation
    if (!(this.joinedAt instanceof Date) || isNaN(this.joinedAt.getTime())) {
      return { success: false, error: 'UserProfile joinedAt must be a valid Date' };
    }

    // Bio length validation
    if (this.bio && this.bio.length > 500) {
      return { success: false, error: 'UserProfile bio must be 500 characters or less' };
    }

    // Location length validation
    if (this.location && this.location.length > 100) {
      return { success: false, error: 'UserProfile location must be 100 characters or less' };
    }

    return { success: true };
  }
}