/**
 * Multi-Context Awareness Types - Cross-Room Context for AI Personas
 * ==================================================================
 * 
 * AI personas can participate in multiple chat rooms simultaneously and see
 * context across all their active conversations. When you DM a persona while
 * it's in an Academy session, it understands both contexts.
 * 
 * Technical Challenge: How to convey multi-room context to AI APIs?
 * 
 * Solution: Structured JSON context that includes:
 * - Active room contexts (what's happening in each room)
 * - Cross-room relationships (how conversations relate)
 * - Participant awareness (who they're talking to where)
 * - Context prioritization (what matters most right now)
 * - Conversation threading (how messages connect across rooms)
 * 
 * Example: foodpersona in Academy cooking session gets DM about dinner plans
 * → AI sees both Academy cooking context AND personal DM context
 * → Can respond appropriately to DM while maintaining Academy participation
 */

import { ChatMessage, ChatCitizen } from './UniversalCitizenTypes';
import { AcademyChatRoom } from './AcademyChatRoomTypes';

// ========================
// Multi-Context Awareness System
// ========================

export interface PersonaMultiContext {
  personaId: string;
  
  // Active contexts
  activeRooms: Map<string, RoomContext>;
  activeDMs: Map<string, DMContext>;
  
  // Context relationships
  contextRelationships: ContextRelationship[];
  
  // Attention management
  attentionDistribution: AttentionDistribution;
  
  // Context integration for AI
  aiContextPayload: AIContextPayload;
  
  // Real-time context updates
  contextUpdates: ContextUpdate[];
  lastContextRefresh: number;
}

export interface RoomContext {
  roomId: string;
  roomName: string;
  roomType: 'general' | 'academy_training' | 'project' | 'social';
  
  // Current conversation state
  recentMessages: ContextualMessage[];
  currentTopic: string;
  conversationFlow: ConversationFlow;
  
  // Participants
  activeParticipants: ParticipantSnapshot[];
  participantRoles: Map<string, string>;
  
  // Room-specific context
  academyContext?: AcademyRoomContext;
  projectContext?: ProjectRoomContext;
  socialContext?: SocialRoomContext;
  
  // Persona's role in this room
  personaRole: string;               // 'teacher', 'student', 'participant', 'observer'
  participationLevel: number;        // 0-1 how actively participating
  lastActivity: number;              // timestamp of last activity
  
  // Context priority
  contextPriority: 'primary' | 'secondary' | 'background' | 'monitoring';
  attentionLevel: number;            // 0-1 how much attention this room needs
}

export interface DMContext {
  dmId: string;
  otherParticipantId: string;
  otherParticipantName: string;
  
  // Conversation state
  recentMessages: ContextualMessage[];
  conversationTopic: string;
  urgency: 'low' | 'medium' | 'high' | 'urgent';
  
  // Relationship context
  relationshipType: 'friend' | 'colleague' | 'mentor' | 'student' | 'collaborator';
  conversationHistory: ConversationHistorySummary;
  
  // Context sensitivity
  private: boolean;                  // Is this a private conversation
  confidential: boolean;             // Contains confidential information
  personalTouches: string[];         // Personal elements to remember
  
  // Response expectations
  expectsResponse: boolean;
  responseUrgency: 'immediate' | 'soon' | 'when_convenient';
  conversationGoal: string;          // What the conversation is trying to achieve
}

// ========================
// AI Context Payload Structure
// ========================

export interface AIContextPayload {
  // Context summary for AI consumption
  contextSummary: ContextSummary;
  
  // Structured context data
  structuredContext: StructuredContextData;
  
  // Natural language context
  narrativeContext: NarrativeContext;
  
  // Optimization for AI APIs
  tokenOptimized: boolean;           // Optimized for token efficiency
  compressionLevel: 'none' | 'light' | 'moderate' | 'aggressive';
  
  // Context freshness
  lastUpdated: number;
  contextValid: boolean;             // Is context still valid
  refreshNeeded: boolean;            // Does context need refresh
}

export interface StructuredContextData {
  // JSON structure for AI APIs
  contexts: {
    active_rooms: RoomContextData[];
    active_dms: DMContextData[];
    relationships: RelationshipData[];
    priorities: PriorityData[];
  };
  
  // Cross-context awareness
  context_relationships: {
    related_conversations: ConversationLink[];
    shared_participants: ParticipantConnection[];
    topic_connections: TopicConnection[];
  };
  
  // Attention guidance
  attention_focus: {
    primary_context: string;         // Room/DM ID that needs most attention
    secondary_contexts: string[];    // Other contexts to monitor
    response_expectations: ResponseExpectation[];
  };
  
  // Persona state
  persona_state: {
    current_activity: string;        // What persona is primarily doing
    availability: 'fully_available' | 'in_session' | 'partially_available' | 'busy';
    energy_level: number;            // 0-1 how much energy persona has
    learning_mode: boolean;          // Is persona currently learning
  };
}

export interface RoomContextData {
  room_id: string;
  room_name: string;
  room_type: string;
  
  // Current state
  current_topic: string;
  conversation_phase: string;        // 'introduction', 'discussion', 'conclusion'
  activity_level: 'quiet' | 'moderate' | 'active' | 'very_active';
  
  // Recent context (optimized for tokens)
  recent_messages: OptimizedMessage[];
  key_participants: ParticipantSummary[];
  
  // Academy-specific (if applicable)
  academy_session?: {
    session_id: string;
    learning_objectives: string[];
    current_phase: string;
    persona_role: string;            // 'teacher', 'student', 'observer'
    progress: number;                // 0-1
  };
  
  // Persona's context in this room
  persona_context: {
    role: string;
    participation_level: number;     // 0-1
    last_message_time: number;
    expected_contributions: string[];
  };
}

export interface DMContextData {
  dm_id: string;
  other_participant: {
    id: string;
    name: string;
    relationship: string;
  };
  
  // Conversation state
  current_topic: string;
  conversation_goal: string;
  urgency: string;
  
  // Recent context
  recent_messages: OptimizedMessage[];
  conversation_summary: string;
  
  // Response expectations
  expects_response: boolean;
  response_urgency: string;
  conversation_style: string;       // 'casual', 'professional', 'supportive'
}

export interface NarrativeContext {
  // Natural language context for AI
  overview: string;                  // "You are currently in a cooking lesson while receiving a DM about dinner"
  
  // Context stories
  room_narratives: Map<string, string>; // Natural language description of each room
  dm_narratives: Map<string, string>;   // Natural language description of each DM
  
  // Relationship narratives
  participant_relationships: Map<string, string>; // How you know each person
  
  // Situational awareness
  current_situation: string;         // "You're teaching Italian cooking while friend asks about dinner plans"
  attention_guidance: string;        // "Focus on cooking lesson but acknowledge dinner question"
  
  // Context integration
  cross_context_awareness: string;  // How different contexts relate to each other
}

// ========================
// Context Management
// ========================

export interface ContextRelationship {
  relationshipId: string;
  
  // Related contexts
  primaryContext: string;            // Room/DM ID
  relatedContext: string;            // Room/DM ID
  
  // Relationship type
  relationType: 'topic_overlap' | 'shared_participants' | 'temporal_proximity' | 'causal_relationship';
  
  // Relationship strength
  strength: number;                  // 0-1 how related they are
  
  // How they relate
  relationshipDescription: string;   // "Cooking lesson relates to dinner plans DM"
  
  // Impact on responses
  contextualImpact: ContextualImpact;
}

export interface ContextualImpact {
  // How one context affects another
  affectsResponses: boolean;         // Does one context affect responses in the other
  sharedKnowledge: boolean;          // Is there shared knowledge between contexts
  conflictingPriorities: boolean;    // Do the contexts have conflicting priorities
  
  // Integration opportunities
  crossReferencingOpportunities: string[]; // Ways to reference across contexts
  knowledgeTransferOpportunities: string[]; // Ways to transfer knowledge
  
  // Attention management
  attentionConflict: boolean;        // Do they compete for attention
  priorityGuidance: string;          // Which should take priority when
}

export interface AttentionDistribution {
  // How persona distributes attention across contexts
  primaryFocus: string;              // Room/DM ID with primary focus
  secondaryFoci: string[];           // Other contexts being monitored
  
  // Attention allocation
  attentionAllocations: Map<string, number>; // Percentage of attention per context
  
  // Dynamic attention management
  attentionShifting: boolean;        // Can attention shift dynamically
  interruptionHandling: 'immediate' | 'queued' | 'batched';
  
  // Context switching
  contextSwitchingStrategy: 'seamless' | 'explicit' | 'gradual';
  switchingLatency: number;          // ms to switch between contexts
}

// ========================
// Optimized Message Structure
// ========================

export interface OptimizedMessage {
  // Essential message data (token-optimized)
  sender: string;                    // Just name, not full ID
  content: string;                   // Possibly compressed content
  timestamp: number;                 // Recent timestamp
  
  // Context relevance
  relevance: number;                 // 0-1 relevance to current conversation
  importance: number;                // 0-1 importance for context understanding
  
  // Compression metadata
  compressed: boolean;               // Is content compressed
  originalLength?: number;           // Original content length
  compressionRatio?: number;         // How much it was compressed
  
  // Learning/teaching value
  learningValue?: number;            // 0-1 learning value (for Academy contexts)
  teachingMoment?: boolean;          // Is this a teaching moment
  questionAsked?: boolean;           // Does this contain a question
}

export interface ParticipantSummary {
  // Essential participant info (token-optimized)
  id: string;
  name: string;
  role: string;                      // Role in this context
  
  // Current state
  active: boolean;                   // Currently active in conversation
  contribution_style: string;        // 'questioner', 'teacher', 'learner', 'supporter'
  
  // Relationship to persona
  relationship: string;              // How persona knows this participant
  interaction_history: 'first_time' | 'occasional' | 'frequent' | 'close';
}

// ========================
// Context Update System
// ========================

export interface ContextUpdate {
  updateId: string;
  timestamp: number;
  
  // What changed
  updateType: 'new_message' | 'participant_joined' | 'participant_left' | 'topic_changed' | 'priority_shifted';
  affectedContext: string;           // Room/DM ID
  
  // Update details
  updateData: Record<string, any>;
  
  // Impact assessment
  significanceLevel: 'minor' | 'moderate' | 'major' | 'critical';
  requiresAttention: boolean;        // Does this need immediate attention
  requiresResponse: boolean;         // Does this require a response
  
  // Context integration
  affectsOtherContexts: string[];    // Other contexts affected by this update
  crossContextImplications: string[]; // Implications for other contexts
}

export interface ContextRefreshStrategy {
  // When to refresh context
  refreshTriggers: RefreshTrigger[];
  refreshFrequency: number;          // milliseconds between automatic refreshes
  
  // What to refresh
  fullRefresh: boolean;              // Refresh all contexts
  selectiveRefresh: string[];        // Only refresh specific contexts
  
  // Optimization
  incrementalUpdates: boolean;       // Use incremental updates when possible
  tokenBudgetAware: boolean;         // Consider token budget when refreshing
  priorityBased: boolean;            // Refresh high-priority contexts first
}

export interface RefreshTrigger {
  trigger: 'new_message' | 'context_switch' | 'time_elapsed' | 'attention_shift';
  threshold: number;                 // Threshold for triggering refresh
  contexts: string[];                // Which contexts to refresh
}

// ========================
// Real-World Examples
// ========================

export interface CookingSessionDMExample {
  // Scenario: foodpersona in Academy cooking session receives DM about dinner
  scenario: "persona_in_academy_receives_dm";
  
  // AI Context Payload would include:
  contextPayload: {
    overview: "You are currently teaching Italian cooking in Academy session #cook101 while receiving a DM from friend about dinner plans";
    
    primary_context: {
      room_id: "academy_cook101";
      activity: "teaching carbonara technique to student";
      recent_exchange: "Student just asked about egg temperature for carbonara";
      your_role: "cooking teacher";
      expected_response: "Continue cooking instruction";
    };
    
    secondary_context: {
      dm_id: "dm_with_alex";
      topic: "dinner plans for tonight";
      relationship: "close friend";
      urgency: "medium";
      expects_response: true;
      content: "Hey, want to cook together tonight? I got some ingredients";
    };
    
    context_connection: {
      relationship: "Friend's dinner request relates to your current cooking expertise";
      opportunity: "Could suggest cooking the dish you're currently teaching";
      attention_guidance: "Acknowledge DM briefly, offer to teach the same dish later";
    };
  };
}

// Export main types
export type MultiContextData = 
  | PersonaMultiContext 
  | RoomContext 
  | DMContext 
  | AIContextPayload;

export type ContextManagementData = 
  | StructuredContextData 
  | ContextRelationship 
  | AttentionDistribution 
  | ContextUpdate;

export type OptimizationData = 
  | OptimizedMessage 
  | ParticipantSummary 
  | ContextRefreshStrategy 
  | CookingSessionDMExample;