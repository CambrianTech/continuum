/**
 * ChatEvents - JTAG-compatible chat event definitions
 * 
 * Integrates with distributed event architecture from:
 * middle-out/architecture/distributed-event-architecture.md
 * 
 * Uses JTAG transport layer for cross-platform event delivery
 * with type-safe EventMessage<T> foundation and router-based routing.
 */

import { JTAGEventMessage } from '../../../shared/JTAGEventSystem';

// ==================== CHAT EVENT TYPES ====================

/**
 * Chat message event - core chat communication
 */
export interface ChatMessageEvent extends JTAGEventMessage<'chat.message'> {
  data: {
    messageId: string;
    conversationId: string;
    senderId: string;
    senderName: string;
    senderType: 'human' | 'ai_assistant' | 'persona' | 'system';
    content: string;
    messageType: 'text' | 'command' | 'system' | 'image' | 'file' | 'code';
    timestamp: number;
    
    // Context information
    context: {
      roomId?: string;
      threadId?: string;
      responseToMessageId?: string;
      mentions: string[];
      attachments: string[];
    };
    
    // Chat-specific metadata
    metadata: {
      isEdited: boolean;
      editedAt?: number;
      isDeleted: boolean;
      deletedAt?: number;
      reactions: Array<{
        emoji: string;
        userIds: string[];
        timestamp: number;
      }>;
    };
  };
}

/**
 * Chat participant event - user join/leave/status
 */
export interface ChatParticipantEvent extends JTAGEventMessage<'chat.participant'> {
  data: {
    participantId: string;
    participantName: string;
    participantType: 'human' | 'ai_assistant' | 'persona' | 'system';
    action: 'joined' | 'left' | 'status_changed' | 'typing' | 'stopped_typing';
    
    // Room context
    roomId: string;
    roomName: string;
    
    // Status information
    status: {
      isOnline: boolean;
      isTyping: boolean;
      lastSeen: number;
      customStatus?: string;
    };
    
    // Participant metadata
    metadata: {
      displayName?: string;
      avatar?: string;
      role: 'user' | 'admin' | 'moderator' | 'guest';
      capabilities: string[];
      preferences: Record<string, any>;
    };
  };
}

/**
 * Chat room event - room management
 */
export interface ChatRoomEvent extends JTAGEventMessage<'chat.room'> {
  data: {
    roomId: string;
    roomName: string;
    roomType: 'general' | 'private' | 'academy' | 'persona' | 'system' | 'debug';
    action: 'created' | 'updated' | 'deleted' | 'archived';
    
    // Room configuration
    config: {
      isPrivate: boolean;
      maxParticipants: number;
      allowGuests: boolean;
      enableHistory: boolean;
      enableCommands: boolean;
    };
    
    // Room state
    state: {
      participantCount: number;
      messageCount: number;
      lastActivity: number;
      isActive: boolean;
    };
    
    // Room metadata
    metadata: {
      description: string;
      createdBy: string;
      createdAt: number;
      updatedAt: number;
      tags: string[];
      settings: Record<string, any>;
    };
  };
}

/**
 * Chat command event - command execution in chat
 */
export interface ChatCommandEvent extends JTAGEventMessage<'chat.command'> {
  data: {
    commandId: string;
    commandName: string;
    commandArgs: string[];
    executedBy: string;
    executedAt: number;
    
    // Execution context
    context: {
      roomId: string;
      messageId: string;
      conversationId: string;
      permissions: string[];
    };
    
    // Command result
    result: {
      success: boolean;
      output?: string;
      error?: string;
      data?: any;
      executionTime: number;
    };
    
    // Command metadata
    metadata: {
      description: string;
      usage: string;
      requiredPermissions: string[];
      isSystemCommand: boolean;
    };
  };
}

// ==================== ACADEMY-AWARE CHAT EVENTS ====================

/**
 * Academy chat event - chat with persona evolution tracking
 */
export interface AcademyChatEvent extends JTAGEventMessage<'academy.chat'> {
  data: {
    // Base chat message
    message: ChatMessageEvent['data'];
    
    // Academy context
    academy: {
      academyId: string;
      personaId: string;
      sessionId: string;
      trainingMode: boolean;
    };
    
    // Performance tracking
    performance: {
      technicalAccuracy: number;      // 0-1 score
      collaborationQuality: number;   // 0-1 score
      humanSatisfaction: number;      // 0-1 score
      responseLatency: number;        // milliseconds
      contextRelevance: number;       // 0-1 score
      innovationLevel: number;        // 0-1 score
    };
    
    // Learning data collection
    learning: {
      conversationContext: string[];
      userIntent: string;
      responseQuality: number;
      learningOpportunities: string[];
      patternMatches: string[];
      trainingValue: number;          // How valuable for training
    };
    
    // Evolution triggers
    evolution?: {
      triggered: boolean;
      reason: 'performance_gap' | 'new_pattern' | 'collaboration_failure' | 'innovation_opportunity';
      capabilityGaps: string[];
      suggestedImprovements: string[];
      urgency: 'low' | 'medium' | 'high';
    };
  };
}

// ==================== EVENT UNION TYPES ====================

export type ChatEventType = 
  | ChatMessageEvent
  | ChatParticipantEvent  
  | ChatRoomEvent
  | ChatCommandEvent
  | AcademyChatEvent;

export type ChatEventTypeString = 
  | 'chat.message'
  | 'chat.participant'
  | 'chat.room'
  | 'chat.command'
  | 'academy.chat';

// ==================== EVENT CREATION HELPERS ====================

/**
 * Create chat message event
 */
export function createChatMessageEvent(
  nodeId: string,
  messageData: {
    messageId: string;
    conversationId: string;
    senderId: string;
    senderName: string;
    senderType: 'human' | 'ai_assistant' | 'persona' | 'system';
    content: string;
    messageType?: 'text' | 'command' | 'system' | 'image' | 'file' | 'code';
    roomId?: string;
    threadId?: string;
    responseToMessageId?: string;
    mentions?: string[];
    attachments?: string[];
  }
): ChatMessageEvent {
  return {
    id: `chat-msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
    type: 'chat.message',
    timestamp: Date.now(),
    nodeId,
    priority: 'medium',
    data: {
      messageId: messageData.messageId,
      conversationId: messageData.conversationId,
      senderId: messageData.senderId,
      senderName: messageData.senderName,
      senderType: messageData.senderType,
      content: messageData.content,
      messageType: messageData.messageType || 'text',
      timestamp: Date.now(),
      context: {
        roomId: messageData.roomId,
        threadId: messageData.threadId,
        responseToMessageId: messageData.responseToMessageId,
        mentions: messageData.mentions || [],
        attachments: messageData.attachments || []
      },
      metadata: {
        isEdited: false,
        isDeleted: false,
        reactions: []
      }
    }
  };
}

/**
 * Create Academy chat event from regular chat message
 */
export function createAcademyChatEvent(
  nodeId: string,
  chatMessage: ChatMessageEvent['data'],
  academyContext: {
    academyId: string;
    personaId: string;
    sessionId: string;
    trainingMode: boolean;
  },
  performanceMetrics: {
    technicalAccuracy: number;
    collaborationQuality: number;
    humanSatisfaction: number;
    responseLatency: number;
    contextRelevance: number;
    innovationLevel: number;
  }
): AcademyChatEvent {
  return {
    id: `academy-chat-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
    type: 'academy.chat',
    timestamp: Date.now(),
    nodeId,
    priority: 'high',
    data: {
      message: chatMessage,
      academy: academyContext,
      performance: performanceMetrics,
      learning: {
        conversationContext: [], // TODO: Extract from message history
        userIntent: '', // TODO: Analyze user intent
        responseQuality: (performanceMetrics.technicalAccuracy + performanceMetrics.contextRelevance) / 2,
        learningOpportunities: [], // TODO: Identify learning opportunities
        patternMatches: [], // TODO: Match against known patterns
        trainingValue: performanceMetrics.technicalAccuracy * performanceMetrics.contextRelevance
      }
    }
  };
}

// ==================== EVENT VALIDATION ====================

export function validateChatMessageEvent(event: Partial<ChatMessageEvent>): { valid: boolean; errors: string[] } {
  const errors: string[] = [];
  
  if (!event.data?.messageId) {
    errors.push('Message ID is required');
  }
  
  if (!event.data?.conversationId) {
    errors.push('Conversation ID is required');
  }
  
  if (!event.data?.senderId) {
    errors.push('Sender ID is required');
  }
  
  if (!event.data?.content) {
    errors.push('Message content is required');
  }
  
  return {
    valid: errors.length === 0,
    errors
  };
}

// ==================== CONSTANTS ====================

export const CHAT_EVENT_CONSTANTS = {
  // Message limits
  MAX_MESSAGE_LENGTH: 10000,
  MAX_ATTACHMENTS_PER_MESSAGE: 10,
  MAX_MENTIONS_PER_MESSAGE: 20,
  
  // Room limits
  MAX_PARTICIPANTS_PER_ROOM: 100,
  MAX_ROOMS_PER_USER: 50,
  
  // Performance thresholds for Academy integration
  ACADEMY_PERFORMANCE_THRESHOLD: 0.7,
  EVOLUTION_TRIGGER_THRESHOLD: 0.3,
  
  // Event priorities
  SYSTEM_MESSAGE_PRIORITY: 'high' as const,
  USER_MESSAGE_PRIORITY: 'medium' as const,
  ACADEMY_MESSAGE_PRIORITY: 'high' as const,
  
  // TTL values
  MESSAGE_EVENT_TTL: 3600,        // 1 hour
  ACADEMY_EVENT_TTL: 7200,        // 2 hours for learning data
  SYSTEM_EVENT_TTL: 1800          // 30 minutes
} as const;