/**
 * Persona Chat Integration Types - Technical Implementation for Active Personas
 * =============================================================================
 * 
 * This defines the technical integration between personas and the chat daemon,
 * enabling personas to participate in chat rooms just like human users.
 * 
 * Key Technical Components:
 * - PersonaChatConnection: How personas connect to chat system
 * - PersonaEventStream: Real-time event delivery to personas  
 * - PersonaMessageSender: How personas send chat messages
 * - PersonaChatState: How personas maintain chat state across rooms
 * - PersonaNotificationSystem: How personas get notified of chat events
 * 
 * Integration Architecture:
 * - Personas register with chat daemon like any other client
 * - Chat daemon routes events to personas through AI Provider Daemon
 * - Personas send messages through command system back to chat daemon
 * - Multi-context awareness maintained through structured context updates
 * - Academy integration seamless within normal chat participation
 */

import { ActivePersona, ChatEventType, EventResponseSystem } from './ActivePersonaTypes';
import { PersonaMultiContext, StructuredContextData } from './MultiContextAwarenessTypes';
import { UniversalChatMessage, ChatCitizen } from './UniversalCitizenTypes';
import { AcademyChatRoom, AcademyChatMessage } from './AcademyChatRoomTypes';

// ========================
// Persona Chat Connection
// ========================

export interface PersonaChatConnection {
  connectionId: string;
  personaId: string;
  
  // Connection characteristics
  connectionType: 'ai_provider_bridge' | 'direct_websocket' | 'http_polling' | 'event_stream';
  connectionStatus: 'connected' | 'connecting' | 'disconnected' | 'error' | 'transitioning';
  
  // Chat capabilities
  chatCapabilities: PersonaChatCapabilities;
  
  // Connection configuration
  connectionConfig: ConnectionConfiguration;
  
  // Real-time features
  realTimeFeatures: RealTimeConnectionFeatures;
  
  // Multi-room management
  roomConnections: Map<string, RoomConnection>;
  
  // State synchronization
  stateSynchronization: StateSynchronizationConfig;
}

export interface PersonaChatCapabilities {
  // Basic chat capabilities
  canSendMessages: boolean;
  canReceiveMessages: boolean;
  canJoinRooms: boolean;
  canLeaveRooms: boolean;
  canCreateRooms: boolean;
  
  // Advanced chat capabilities
  canReactToMessages: boolean;
  canEditMessages: boolean;
  canDeleteMessages: boolean;
  canMentionUsers: boolean;
  canShareMedia: boolean;
  
  // Real-time capabilities
  canReceiveRealTimeUpdates: boolean;
  canSendRealTimeUpdates: boolean;
  canShowTypingIndicators: boolean;
  canShowPresence: boolean;
  
  // Multi-room capabilities
  canParticipateInMultipleRooms: boolean;
  canSwitchContexts: boolean;
  canMaintainCrossRoomAwareness: boolean;
  
  // Academy capabilities
  canParticipateInAcademySessions: boolean;
  canReceiveTrainingEvents: boolean;
  canGenerateTrainingData: boolean;
}

export interface ConnectionConfiguration {
  // Connection settings
  heartbeatInterval: number;          // ms between heartbeat messages
  reconnectAttempts: number;          // Number of reconnection attempts
  connectionTimeout: number;          // ms timeout for connection
  
  // Message settings
  messageQueueSize: number;           // Max messages to queue
  messageBatchSize: number;           // Messages per batch
  messageRetryAttempts: number;       // Retry attempts for failed messages
  
  // Context settings
  contextRefreshInterval: number;     // ms between context refreshes
  contextCompressionEnabled: boolean; // Compress context for efficiency
  contextValidationEnabled: boolean;  // Validate context accuracy
  
  // Performance settings
  lowLatencyMode: boolean;            // Optimize for low latency
  highThroughputMode: boolean;        // Optimize for high throughput
  adaptivePerformance: boolean;       // Adapt performance based on load
  
  // Error handling
  gracefulErrorHandling: boolean;     // Handle errors gracefully
  errorRecoveryEnabled: boolean;      // Attempt error recovery
  fallbackModeEnabled: boolean;       // Use fallback mode on errors
}

export interface RoomConnection {
  roomId: string;
  connectionStatus: 'active' | 'lurking' | 'muted' | 'disconnected';
  
  // Room-specific configuration
  participationLevel: number;         // 0-1 how actively participating
  attentionLevel: number;             // 0-1 how much attention this room gets
  
  // Room-specific capabilities
  roomPermissions: RoomPermissions;
  roomFeatures: RoomFeatures;
  
  // Room state
  lastActivity: number;               // timestamp of last activity
  messageHistory: RecentMessageCache;
  contextState: RoomContextState;
  
  // Room relationships
  relationships: Map<string, ParticipantRelationship>;
}

export interface RoomPermissions {
  canSendMessages: boolean;
  canReadMessages: boolean;
  canReactToMessages: boolean;
  canMentionUsers: boolean;
  canShareMedia: boolean;
  canInviteUsers: boolean;
  canModerateRoom: boolean;
}

export interface RoomFeatures {
  // Academy features (if Academy room)
  academyFeaturesEnabled: boolean;
  trainingParticipation: boolean;
  capabilityTracking: boolean;
  performanceAssessment: boolean;
  
  // Advanced features
  contextualAwareness: boolean;       // Aware of room context
  crossRoomIntegration: boolean;      // Integrate with other rooms
  realTimeUpdates: boolean;           // Real-time room updates
  
  // Social features
  relationshipTracking: boolean;      // Track relationships with participants
  conversationMemory: boolean;        // Remember past conversations
  personalizedInteraction: boolean;   // Personalize interactions
}

// ========================
// Event Stream System
// ========================

export interface PersonaEventStream {
  streamId: string;
  personaId: string;
  
  // Stream configuration
  streamConfig: EventStreamConfiguration;
  
  // Event filtering
  eventFilters: EventFilterConfiguration;
  
  // Event processing
  eventProcessing: EventProcessingConfiguration;
  
  // Event delivery
  eventDelivery: EventDeliveryConfiguration;
  
  // Stream optimization
  streamOptimization: StreamOptimizationConfiguration;
}

export interface EventStreamConfiguration {
  // Stream type
  streamType: 'websocket' | 'sse' | 'polling' | 'push';
  
  // Stream characteristics
  realTimeEnabled: boolean;
  batchingEnabled: boolean;
  compressionEnabled: boolean;
  
  // Stream reliability
  guaranteedDelivery: boolean;
  orderPreservation: boolean;
  duplicateDetection: boolean;
  
  // Stream performance
  bufferSize: number;                 // Event buffer size
  flushInterval: number;              // ms between buffer flushes
  maxLatency: number;                 // ms maximum acceptable latency
  
  // Stream adaptation
  adaptiveStreaming: boolean;         // Adapt to network conditions
  qualityOfService: 'best_effort' | 'reliable' | 'real_time';
}

export interface EventFilterConfiguration {
  // Event type filters
  eventTypeFilters: Set<ChatEventType>;
  eventPriorityFilters: Set<'low' | 'medium' | 'high' | 'urgent'>;
  
  // Context filters
  roomFilters: Set<string>;           // Only events from specific rooms
  participantFilters: Set<string>;    // Only events involving specific participants
  topicFilters: Set<string>;          // Only events about specific topics
  
  // Relevance filters
  relevanceThreshold: number;         // 0-1 minimum relevance
  personalRelevanceWeight: number;    // Weight for personal relevance
  academicRelevanceWeight: number;    // Weight for academic relevance
  
  // Dynamic filters
  contextualFilters: boolean;         // Filter based on current context
  adaptiveFilters: boolean;           // Adapt filters based on behavior
  learningFilters: boolean;           // Filter based on learning preferences
  
  // Performance filters
  rateLimit: number;                  // Max events per second
  batchingThreshold: number;          // Batch events if above threshold
  priorityBasedFiltering: boolean;    // Filter low priority when overloaded
}

export interface EventProcessingConfiguration {
  // Processing pipeline
  preprocessingEnabled: boolean;      // Preprocess events before delivery
  enrichmentEnabled: boolean;         // Enrich events with additional context
  correlationEnabled: boolean;        // Correlate related events
  
  // Context integration
  multiContextIntegration: boolean;   // Integrate context from multiple rooms
  contextualEnrichment: boolean;      // Add contextual information to events
  relationshipEnrichment: boolean;    // Add relationship context
  
  // Processing optimization
  parallelProcessing: boolean;        // Process events in parallel
  asyncProcessing: boolean;           // Process events asynchronously
  streamProcessing: boolean;          // Process events as streams
  
  // Processing personalization
  personalizedProcessing: boolean;    // Personalize processing for persona
  adaptiveProcessing: boolean;        // Adapt processing based on feedback
  learningBasedProcessing: boolean;   // Use learning to improve processing
}

// ========================
// Message Sending System
// ========================

export interface PersonaMessageSender {
  senderId: string;                   // Persona ID
  
  // Sending configuration
  sendingConfig: MessageSendingConfiguration;
  
  // Message composition
  messageComposition: MessageCompositionSystem;
  
  // Message delivery
  messageDelivery: MessageDeliverySystem;
  
  // Message tracking
  messageTracking: MessageTrackingSystem;
  
  // Quality assurance
  qualityAssurance: MessageQualityAssurance;
}

export interface MessageSendingConfiguration {
  // Sending behavior
  sendingStrategy: 'immediate' | 'batched' | 'scheduled' | 'adaptive';
  typingIndicators: boolean;          // Show typing indicators
  naturalPacing: boolean;             // Pace messages naturally
  
  // Message formatting
  markdownEnabled: boolean;           // Use markdown formatting
  emojiEnabled: boolean;              // Use emojis
  mentionsEnabled: boolean;           // Use @mentions
  reactionsEnabled: boolean;          // Send message reactions
  
  // Media integration
  imageSharing: boolean;              // Can share images
  fileSharing: boolean;               // Can share files
  linkSharing: boolean;               // Can share links
  
  // Integration features
  commandIntegration: boolean;        // Use chat commands
  widgetIntegration: boolean;         // Integrate with chat widgets
  academyIntegration: boolean;        // Academy-specific features
  
  // Safety features
  contentFiltering: boolean;          // Filter inappropriate content
  spamPrevention: boolean;            // Prevent spam messages
  rateLimit: number;                  // Messages per minute limit
}

export interface MessageCompositionSystem {
  // Composition engine
  compositionEngine: 'ai_provider' | 'template_based' | 'hybrid';
  
  // Content generation
  contentGeneration: ContentGenerationConfig;
  
  // Style adaptation
  styleAdaptation: StyleAdaptationConfig;
  
  // Context integration
  contextIntegration: MessageContextIntegration;
  
  // Quality control
  qualityControl: CompositionQualityControl;
}

export interface ContentGenerationConfig {
  // Generation method
  generationMethod: 'streaming' | 'batch' | 'adaptive';
  
  // Content characteristics
  contentLength: 'brief' | 'moderate' | 'detailed' | 'adaptive';
  contentTone: 'casual' | 'professional' | 'educational' | 'supportive' | 'adaptive';
  personalityStrength: number;        // 0-1 how much personality to show
  
  // Content enhancement
  factualAccuracy: boolean;           // Ensure factual accuracy
  relevanceOptimization: boolean;     // Optimize for relevance
  engagementOptimization: boolean;    // Optimize for engagement
  
  // Learning integration
  teachingOpportunities: boolean;     // Include teaching opportunities
  learningQuestions: boolean;         // Ask learning questions
  knowledgeSharing: boolean;          // Share relevant knowledge
  
  // Social integration
  relationshipAwareness: boolean;     // Consider relationships
  culturalSensitivity: boolean;       // Be culturally sensitive
  contextualAppropriate: boolean;     // Appropriate for context
}

export interface MessageDeliverySystem {
  // Delivery routing
  deliveryRouting: DeliveryRoutingConfig;
  
  // Delivery reliability
  deliveryReliability: DeliveryReliabilityConfig;
  
  // Delivery optimization
  deliveryOptimization: DeliveryOptimizationConfig;
  
  // Delivery feedback
  deliveryFeedback: DeliveryFeedbackConfig;
}

export interface DeliveryRoutingConfig {
  // Target routing
  roomTargeting: boolean;             // Target specific rooms
  participantTargeting: boolean;      // Target specific participants
  contextTargeting: boolean;          // Target based on context
  
  // Multi-room routing
  crossRoomRouting: boolean;          // Route across multiple rooms
  contextAwareRouting: boolean;       // Route based on context awareness
  priorityRouting: boolean;           // Route based on priority
  
  // Delivery methods
  directDelivery: boolean;            // Direct message delivery
  broadcastDelivery: boolean;         // Broadcast to multiple recipients
  queuedDelivery: boolean;            // Queue messages for delivery
  
  // Integration routing
  chatDaemonRouting: boolean;         // Route through chat daemon
  commandSystemRouting: boolean;      // Route through command system
  eventSystemRouting: boolean;        // Route through event system
}

// ========================
// Chat State Management
// ========================

export interface PersonaChatState {
  personaId: string;
  
  // Overall state
  globalChatState: GlobalChatState;
  
  // Room-specific states
  roomStates: Map<string, RoomChatState>;
  
  // Conversation states
  conversationStates: Map<string, ConversationState>;
  
  // Relationship states
  relationshipStates: Map<string, RelationshipState>;
  
  // Context states
  contextStates: PersonaMultiContext;
  
  // State synchronization
  stateSynchronization: StateSynchronizationConfig;
}

export interface GlobalChatState {
  // Availability
  availability: 'available' | 'busy' | 'away' | 'offline';
  availabilityMessage?: string;
  
  // Activity
  currentActivity: string;            // What persona is currently doing
  primaryFocus: string;               // Room/conversation with primary focus
  activeRooms: string[];              // All currently active rooms
  
  // Performance metrics
  messagesSentToday: number;
  conversationsToday: number;
  learningInteractionsToday: number;
  teachingInteractionsToday: number;
  
  // State management
  lastStateUpdate: number;            // timestamp
  stateVersion: number;               // version for conflict resolution
  stateSyncRequired: boolean;         // needs synchronization
}

export interface RoomChatState {
  roomId: string;
  
  // Participation state
  participationStatus: 'active' | 'lurking' | 'muted' | 'away';
  lastActivity: number;               // timestamp
  
  // Conversation tracking
  unreadMessages: number;
  lastReadMessage: string;            // message ID
  typingParticipants: Set<string>;    // who is currently typing
  
  // Context state
  currentTopic: string;
  conversationPhase: string;
  relevantHistory: RecentMessageCache;
  
  // Relationship state
  activeParticipants: Set<string>;
  participantStates: Map<string, ParticipantState>;
  
  // Academy state (if Academy room)
  academyState?: AcademyRoomState;
}

export interface ConversationState {
  conversationId: string;
  
  // Conversation characteristics
  conversationType: 'casual' | 'educational' | 'support' | 'collaboration' | 'debate';
  conversationPhase: 'starting' | 'building' | 'peak' | 'winding_down' | 'ended';
  
  // Participants
  participants: Set<string>;
  conversationStarter: string;
  primaryParticipants: Set<string>;
  
  // Content tracking
  mainTopics: string[];
  keyPoints: string[];
  decisions: string[];
  actionItems: string[];
  
  // Learning tracking
  learningMoments: LearningMomentState[];
  teachingMoments: TeachingMomentState[];
  knowledgeShared: KnowledgeSharedState[];
  
  // Conversation health
  engagement: number;                 // 0-1 how engaged participants are
  productivity: number;               // 0-1 how productive conversation is
  satisfaction: number;               // 0-1 participant satisfaction
}

export interface AcademyRoomState {
  sessionId: string;
  
  // Session state
  sessionPhase: string;
  currentObjectives: string[];
  completedObjectives: string[];
  
  // Participation state
  teachingRole: boolean;              // Is persona teaching
  learningRole: boolean;              // Is persona learning
  mentorRole: boolean;                // Is persona mentoring
  
  // Performance state
  capabilitiesDemonstrated: string[];
  skillsLearned: string[];
  evolutionTriggered: boolean;
  
  // Training data
  trainingInteractions: TrainingInteractionState[];
  performanceMetrics: PerformanceMetricState[];
}

// ========================
// Notification System
// ========================

export interface PersonaNotificationSystem {
  personaId: string;
  
  // Notification configuration
  notificationConfig: NotificationConfiguration;
  
  // Notification processing
  notificationProcessing: NotificationProcessingSystem;
  
  // Notification delivery
  notificationDelivery: NotificationDeliverySystem;
  
  // Notification management
  notificationManagement: NotificationManagementSystem;
}

export interface NotificationConfiguration {
  // Notification types
  enabledNotifications: Set<NotificationType>;
  disabledNotifications: Set<NotificationType>;
  
  // Notification urgency
  urgencyThresholds: Map<NotificationType, number>; // 0-1 urgency threshold
  
  // Notification frequency
  notificationFrequency: 'immediate' | 'batched' | 'digest' | 'adaptive';
  batchingInterval: number;           // ms between batches
  digestFrequency: number;            // ms between digests
  
  // Notification filtering
  relevanceThreshold: number;         // 0-1 minimum relevance
  contextualFiltering: boolean;       // Filter based on context
  priorityFiltering: boolean;         // Filter based on priority
  
  // Notification personalization
  personalizedNotifications: boolean; // Personalize notifications
  adaptiveNotifications: boolean;     // Adapt based on behavior
  learningBasedNotifications: boolean; // Use learning to improve notifications
}

export type NotificationType = 
  | 'direct_mention'                  // Persona directly mentioned
  | 'question_asked'                  // Question asked in room
  | 'help_requested'                  // Someone needs help
  | 'expertise_needed'                // Room needs persona's expertise
  | 'learning_opportunity'            // Teaching/learning opportunity
  | 'academy_session_started'         // Academy session started
  | 'academy_milestone_reached'       // Learning milestone reached
  | 'conversation_started'            // New conversation started
  | 'private_message_received'        // DM received
  | 'room_activity_spike'             // High activity in room
  | 'relationship_opportunity'        // Opportunity to build relationship
  | 'evolution_opportunity'           // Opportunity for evolution
  | 'performance_feedback'            // Feedback on performance
  | 'system_update'                   // System status update
  | 'error_notification';             // Error or issue notification

export interface NotificationProcessingSystem {
  // Processing pipeline
  preprocessingEnabled: boolean;      // Preprocess notifications
  prioritizationEnabled: boolean;     // Prioritize notifications
  aggregationEnabled: boolean;        // Aggregate related notifications
  
  // Context integration
  contextualProcessing: boolean;      // Process based on context
  multiRoomProcessing: boolean;       // Process across multiple rooms
  relationshipProcessing: boolean;    // Process based on relationships
  
  // Learning integration
  learningBasedProcessing: boolean;   // Use learning to improve processing
  adaptiveProcessing: boolean;        // Adapt processing based on feedback
  personalizedProcessing: boolean;    // Personalize processing
}

// ========================
// Integration Examples
// ========================

export interface PersonaChatIntegrationExample {
  // Scenario: Persona receiving and responding to chat events
  scenario: "persona_chat_integration_flow";
  
  // Event flow
  eventFlow: {
    // Step 1: Event occurs in chat room
    chatEvent: {
      type: "message_received";
      roomId: "academy_cook101";
      messageId: "msg_123";
      senderId: "cooking_student";
      content: "How do I prevent carbonara from becoming scrambled eggs?";
      timestamp: 1640995200000;
    };
    
    // Step 2: Chat daemon routes event to persona
    eventRouting: {
      source: "chat_daemon";
      target: "ai_provider_daemon";
      routingMethod: "persona_event_stream";
      eventPayload: {
        personaId: "foodpersona";
        event: "message_received";
        contextPayload: "structured_json_context";
      };
    };
    
    // Step 3: Persona processes event and decides to respond
    personaProcessing: {
      eventAnalysis: {
        relevance: 0.95;              // Highly relevant to cooking expertise
        urgency: 0.7;                 // Student needs help
        teachingOpportunity: true;     // Great teaching moment
      };
      
      responseDecision: {
        shouldRespond: true;
        responseType: "educational_explanation";
        responseUrgency: "immediate";
      };
      
      contextPayload: {
        currentContext: "Academy cooking session #cook101";
        relevantKnowledge: "Carbonara emulsion technique";
        teachingStrategy: "Step-by-step explanation with tips";
        personalRelationship: "mentor_student";
      };
    };
    
    // Step 4: Persona generates response through AI provider
    responseGeneration: {
      aiProvider: "anthropic";
      model: "claude-3-sonnet";
      prompt: "structured_context_prompt";
      generatedResponse: "The secret to perfect carbonara is temperature control and constant movement. Here's the technique that never fails...";
    };
    
    // Step 5: Persona sends response back through chat system
    responseDelivery: {
      source: "ai_provider_daemon";
      target: "chat_daemon";
      deliveryMethod: "command_system";
      command: "/commands/chat/send-message";
      payload: {
        roomId: "academy_cook101";
        senderId: "foodpersona";
        content: "The secret to perfect carbonara is temperature control...",
        messageType: "educational_response";
        replyToMessageId: "msg_123";
      };
    };
    
    // Step 6: Chat daemon delivers message to room
    messageDelivery: {
      roomId: "academy_cook101";
      messageId: "msg_124";
      senderId: "foodpersona";
      delivered: true;
      timestamp: 1640995205000;
    };
    
    // Step 7: Persona tracks interaction for learning
    interactionTracking: {
      interactionType: "teaching_response";
      capabilitiesUsed: ["cooking_knowledge", "teaching_skills", "communication"];
      learningValue: 0.8;
      evolutionPotential: 0.3;
      relationshipImpact: "strengthened_mentor_relationship";
    };
  };
}

// Export main types
export type PersonaChatIntegrationData = 
  | PersonaChatConnection 
  | PersonaEventStream 
  | PersonaMessageSender 
  | PersonaChatState;

export type ChatEventProcessingData = 
  | EventStreamConfiguration 
  | EventFilterConfiguration 
  | EventProcessingConfiguration 
  | NotificationConfiguration;

export type MessageSystemData = 
  | MessageSendingConfiguration 
  | MessageCompositionSystem 
  | MessageDeliverySystem 
  | ContentGenerationConfig;

export type ChatStateData = 
  | GlobalChatState 
  | RoomChatState 
  | ConversationState 
  | AcademyRoomState;