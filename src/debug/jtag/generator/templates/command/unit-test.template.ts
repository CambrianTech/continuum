#!/usr/bin/env tsx
/**
 * {{CLASS_NAME}} Command Unit Tests
 *
 * Tests {{COMMAND_NAME}} command logic in isolation using mock dependencies.
 * This is a REFERENCE EXAMPLE showing best practices for command testing.
 *
 * Generated by: ./jtag generate
 * Run with: npx tsx commands/{{COMMAND_NAME}}/test/unit/{{CLASS_NAME}}Command.test.ts
 *
 * NOTE: This is a self-contained test (no external test utilities needed).
 * Use this as a template for your own command tests.
 */

// import { ValidationError } from '../../../../system/core/types/ErrorTypes';  // Uncomment when adding validation tests
import { generateUUID } from '../../../../system/core/types/CrossPlatformUUID';
import type { {{CLASS_NAME}}Params, {{CLASS_NAME}}Result } from '../../shared/{{CLASS_NAME}}Types';

console.log('üß™ {{CLASS_NAME}} Command Unit Tests');

function assert(condition: boolean, message: string): void {
  if (!condition) {
    throw new Error(`‚ùå Assertion failed: ${message}`);
  }
  console.log(`‚úÖ ${message}`);
}

/**
 * Mock command that implements {{COMMAND_NAME}} logic for testing
 */
async function mock{{CLASS_NAME}}Command(params: {{CLASS_NAME}}Params): Promise<{{CLASS_NAME}}Result> {
  // TODO: Validate required parameters (BEST PRACTICE)
  // Example:
  // if (!params.requiredParam || params.requiredParam.trim() === '') {
  //   throw new ValidationError(
  //     'requiredParam',
  //     `Missing required parameter 'requiredParam'. ` +
  //     `Use the help tool with '{{COMMAND_NAME}}' or see the {{COMMAND_NAME}} README for usage information.`
  //   );
  // }

  // TODO: Handle optional parameters with sensible defaults
  // const optionalParam = params.optionalParam ?? defaultValue;

  // TODO: Implement your command logic here
  return {
    success: true,
    // TODO: Add your result fields with actual computed values
    context: params.context,
    sessionId: params.sessionId
  } as {{CLASS_NAME}}Result;
}

/**
 * Test 1: Command structure validation
 */
function test{{CLASS_NAME}}CommandStructure(): void {
  console.log('\nüìã Test 1: {{CLASS_NAME}} command structure validation');

  const context = { environment: 'server' as const };
  const sessionId = generateUUID();

  // Create valid params for {{COMMAND_NAME}} command
  const validParams: {{CLASS_NAME}}Params = {
    // TODO: Add your required parameters here
    context,
    sessionId
  };

  // Validate param structure
  assert(validParams.context !== undefined, 'Params have context');
  assert(validParams.sessionId !== undefined, 'Params have sessionId');
  // TODO: Add assertions for your specific parameters
  // assert(typeof validParams.requiredParam === 'string', 'requiredParam is string');
}

/**
 * Test 2: Mock command execution
 */
async function testMock{{CLASS_NAME}}Execution(): Promise<void> {
  console.log('\n‚ö° Test 2: Mock {{COMMAND_NAME}} command execution');

  const context = { environment: 'server' as const };
  const sessionId = generateUUID();

  // Test mock execution
  const params: {{CLASS_NAME}}Params = {
    // TODO: Add your parameters here
    context,
    sessionId
  };

  const result = await mock{{CLASS_NAME}}Command(params);

  // Validate result structure
  assert(result.success === true, 'Mock result shows success');
  // TODO: Add assertions for your result fields
  // assert(typeof result.yourField === 'string', 'yourField is string');
}

/**
 * Test 3: Required parameter validation (CRITICAL)
 *
 * This test ensures your command throws ValidationError
 * when required parameters are missing (BEST PRACTICE)
 */
async function test{{CLASS_NAME}}RequiredParams(): Promise<void> {
  console.log('\nüö® Test 3: Required parameter validation');

  // TODO: Uncomment when implementing validation
  // const context = { environment: 'server' as const };
  // const sessionId = generateUUID();

  // TODO: Test cases that should throw ValidationError
  // Example:
  // const testCases = [
  //   { params: {} as {{CLASS_NAME}}Params, desc: 'Missing requiredParam' },
  //   { params: { requiredParam: '' } as {{CLASS_NAME}}Params, desc: 'Empty requiredParam' },
  // ];
  //
  // for (const testCase of testCases) {
  //   try {
  //     await mock{{CLASS_NAME}}Command({ ...testCase.params, context, sessionId });
  //     throw new Error(`Should have thrown ValidationError for: ${testCase.desc}`);
  //   } catch (error) {
  //     if (error instanceof ValidationError) {
  //       assert(error.field === 'requiredParam', `ValidationError field is 'requiredParam' for: ${testCase.desc}`);
  //       assert(error.message.includes('required parameter'), `Error message mentions 'required parameter' for: ${testCase.desc}`);
  //       assert(error.message.includes('help tool'), `Error message is tool-agnostic for: ${testCase.desc}`);
  //     } else {
  //       throw error; // Re-throw if not ValidationError
  //     }
  //   }
  // }

  console.log('‚úÖ All required parameter validations work correctly');
}

/**
 * Test 4: Optional parameter handling
 */
async function test{{CLASS_NAME}}OptionalParams(): Promise<void> {
  console.log('\nüîß Test 4: Optional parameter handling');

  // TODO: Uncomment when implementing optional param tests
  // const context = { environment: 'server' as const };
  // const sessionId = generateUUID();

  // TODO: Test WITHOUT optional param (should use default)
  // const paramsWithoutOptional: {{CLASS_NAME}}Params = {
  //   requiredParam: 'test',
  //   context,
  //   sessionId
  // };
  //
  // const resultWithoutOptional = await mock{{CLASS_NAME}}Command(paramsWithoutOptional);
  // assert(resultWithoutOptional.success === true, 'Command succeeds without optional params');

  // TODO: Test WITH optional param
  // const paramsWithOptional: {{CLASS_NAME}}Params = {
  //   requiredParam: 'test',
  //   optionalParam: true,
  //   context,
  //   sessionId
  // };
  //
  // const resultWithOptional = await mock{{CLASS_NAME}}Command(paramsWithOptional);
  // assert(resultWithOptional.success === true, 'Command succeeds with optional params');

  console.log('‚úÖ Optional parameter handling validated');
}

/**
 * Test 5: Performance validation
 */
async function test{{CLASS_NAME}}Performance(): Promise<void> {
  console.log('\n‚ö° Test 5: {{CLASS_NAME}} performance validation');

  const context = { environment: 'server' as const };
  const sessionId = generateUUID();

  const startTime = Date.now();

  await mock{{CLASS_NAME}}Command({
    // TODO: Add your parameters
    context,
    sessionId
  } as {{CLASS_NAME}}Params);

  const executionTime = Date.now() - startTime;

  assert(executionTime < 100, `{{CLASS_NAME}} completed in ${executionTime}ms (under 100ms limit)`);
}

/**
 * Test 6: Result structure validation
 */
async function test{{CLASS_NAME}}ResultStructure(): Promise<void> {
  console.log('\nüîç Test 6: {{CLASS_NAME}} result structure validation');

  const context = { environment: 'server' as const };
  const sessionId = generateUUID();

  // Test various scenarios
  const basicResult = await mock{{CLASS_NAME}}Command({
    // TODO: Add your parameters
    context,
    sessionId
  } as {{CLASS_NAME}}Params);

  assert(basicResult.success === true, 'Result has success field');
  // TODO: Add assertions for your result fields
  // assert(typeof basicResult.yourField === 'string', 'Result has yourField (string)');
  assert(basicResult.context === context, 'Result includes context');
  assert(basicResult.sessionId === sessionId, 'Result includes sessionId');

  console.log('‚úÖ All result structure validations pass');
}

/**
 * Run all unit tests
 */
async function runAll{{CLASS_NAME}}UnitTests(): Promise<void> {
  console.log('üöÄ Starting {{CLASS_NAME}} Command Unit Tests\n');

  try {
    test{{CLASS_NAME}}CommandStructure();
    await testMock{{CLASS_NAME}}Execution();
    await test{{CLASS_NAME}}RequiredParams();
    await test{{CLASS_NAME}}OptionalParams();
    await test{{CLASS_NAME}}Performance();
    await test{{CLASS_NAME}}ResultStructure();

    console.log('\nüéâ ALL {{CLASS_NAME}} UNIT TESTS PASSED!');
    console.log('üìã Validated:');
    console.log('  ‚úÖ Command structure and parameter validation');
    console.log('  ‚úÖ Mock command execution patterns');
    console.log('  ‚úÖ Required parameter validation (throws ValidationError)');
    console.log('  ‚úÖ Optional parameter handling (sensible defaults)');
    console.log('  ‚úÖ Performance requirements (< 100ms)');
    console.log('  ‚úÖ Result structure validation');
    console.log('\nüìù This is a REFERENCE EXAMPLE - use as a template for your commands!');
    console.log('üí° TIP: Copy this test structure and modify for your command logic');

  } catch (error) {
    console.error('\n‚ùå {{CLASS_NAME}} unit tests failed:', (error as Error).message);
    if ((error as Error).stack) {
      console.error((error as Error).stack);
    }
    process.exit(1);
  }
}

// Run if called directly
if (require.main === module) {
  void runAll{{CLASS_NAME}}UnitTests();
} else {
  module.exports = { runAll{{CLASS_NAME}}UnitTests };
}
