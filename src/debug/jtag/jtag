#!/bin/bash
# JTAG Terminal Portal - Ensures system is running and connects CLI

# Use intelligent signal-based startup for foolproof operation
if [[ "$*" == *"--restart"* ]]; then
  echo "üîÑ Restart requested..."
  npm run system:stop
  echo "üöÄ Starting system (browser will launch)..."
  npm run system:start &
  echo "‚è≥ Waiting for intelligent system ready signal..."
  npm run signal:wait
else
  echo "üîç Ensuring JTAG system is running..."
  # Check if already running first
  if npm run signal:check >/dev/null 2>&1; then
    echo "‚úÖ System already ready"
  else
    echo "üöÄ Starting system (browser will launch)..."
    npm run system:start &
    echo "‚è≥ Waiting for intelligent system ready signal..."
    npm run signal:wait
  fi
fi

# Verify system is truly ready before CLI execution
if npm run signal:check >/dev/null 2>&1; then
  echo "‚úÖ JTAG system ready"
  # Forward all args to CLI
  npx tsx cli.ts "$@"
else
  echo "‚ùå System not ready - check: npm run signal:errors"
  exit 1
fi