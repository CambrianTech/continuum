<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JTAG Browser Simulation</title>
    <style>
        body { 
            font-family: monospace; 
            background: #1a1a1a; 
            color: #00ff00; 
            padding: 20px; 
            margin: 0;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        .header { 
            text-align: center; 
            border-bottom: 2px solid #00ff00; 
            padding-bottom: 20px; 
            margin-bottom: 30px; 
        }
        .example-section { 
            border: 1px solid #333; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 5px; 
        }
        .example-section h3 { 
            color: #ffaa00; 
            margin-top: 0; 
        }
        .button { 
            background: #333; 
            color: #00ff00; 
            border: 1px solid #00ff00; 
            padding: 10px 20px; 
            cursor: pointer; 
            margin: 5px; 
            border-radius: 3px;
        }
        .button:hover { 
            background: #00ff00; 
            color: #1a1a1a; 
        }
        .output { 
            background: #000; 
            border: 1px solid #333; 
            padding: 15px; 
            margin: 10px 0; 
            font-size: 12px; 
            max-height: 300px; 
            overflow-y: auto;
        }
        .widget { 
            border: 2px solid #00aa00; 
            padding: 15px; 
            margin: 10px; 
            background: #002200; 
        }
        #test-widget { 
            width: 300px; 
            height: 150px; 
            background: linear-gradient(45deg, #004400, #006600);
        }
        .status { 
            position: fixed; 
            top: 10px; 
            right: 10px; 
            background: #333; 
            padding: 10px; 
            border: 1px solid #00ff00; 
            border-radius: 5px;
        }
        .error { color: #ff4444; }
        .success { color: #44ff44; }
        .warning { color: #ffaa44; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® JTAG Browser Simulation</h1>
            <p>Testing JTAG universal debugging system in browser context</p>
        </div>

        <div class="status" id="status">
            üì° Connecting to JTAG Server...
        </div>

        <div class="example-section">
            <h3>üìù Basic Logging Tests</h3>
            <button class="button" onclick="testBasicLogging()">Test Basic Logging</button>
            <button class="button" onclick="testLogLevels()">Test Log Levels</button>
            <button class="button" onclick="testConfiguration()">Show Configuration</button>
            <div class="output" id="log-output">Click buttons to see JTAG logging in action...</div>
        </div>

        <div class="example-section">
            <h3>üì∏ Screenshot Tests</h3>
            <button class="button" onclick="testScreenshotFull()">Screenshot Full Page</button>
            <button class="button" onclick="testScreenshotWidget()">Screenshot Widget</button>
            <button class="button" onclick="testScreenshotAsync()">Async Screenshot Test</button>
            <div class="widget" id="test-widget">
                <h4>üéØ Test Widget</h4>
                <p>This widget can be captured with selector-based screenshots.</p>
                <p>Widget ID: #test-widget</p>
            </div>
            <div class="output" id="screenshot-output">Screenshot results will appear here...</div>
        </div>

        <div class="example-section">
            <h3>üì¶ Transport Tests</h3>
            <button class="button" onclick="testPayloadTransport()">Test Base64 Transport</button>
            <button class="button" onclick="testLogBatch()">Test Log Batching</button>
            <button class="button" onclick="testCustomPayload()">Test Custom Payload</button>
            <div class="output" id="transport-output">Transport test results will appear here...</div>
        </div>

        <div class="example-section">
            <h3>üîÑ Integration Tests</h3>
            <button class="button" onclick="runFullIntegration()">Run Full Integration</button>
            <button class="button" onclick="simulateError()">Simulate Error Scenario</button>
            <button class="button" onclick="showStatistics()">Show JTAG Statistics</button>
            <div class="output" id="integration-output">Integration test results will appear here...</div>
        </div>
    </div>

    <script>
        // Note: In a real implementation, this would import the actual JTAG module
        // For this simulation, we'll create a mock JTAG object
        
        /**
         * Mock JTAG for Browser Simulation
         * In real usage, this would be: import { jtag } from '@jtag/debug';
         */
        const jtag = {
            config: {
                jtagPort: 9001,
                enableRemoteLogging: true,
                enableConsoleOutput: true,
                logDirectory: '.jtag/logs',
                screenshotDirectory: '.jtag/screenshots',
                context: 'browser'
            },
            
            log: function(component, message, data) {
                this._sendToServer('log', component, message, data);
                this._logToConsole('üìù', component, message, data);
            },
            
            critical: function(component, message, data) {
                this._sendToServer('critical', component, message, data);
                this._logToConsole('üî•', component, message, data);
            },
            
            trace: function(component, functionName, phase, data) {
                const message = `TRACE: ${functionName} ${phase}`;
                this._sendToServer('trace', component, message, data);
                this._logToConsole('üîç', component, message, data);
            },
            
            probe: function(component, probeName, state) {
                const message = `PROBE: ${probeName}`;
                this._sendToServer('probe', component, message, state);
                this._logToConsole('üìä', component, message, state);
            },
            
            screenshot: async function(filename, options = {}) {
                const result = {
                    success: false,
                    filepath: `${this.config.screenshotDirectory}/browser-${filename || 'screenshot'}.png`,
                    filename: filename || `screenshot-${Date.now()}.png`,
                    context: 'browser',
                    timestamp: new Date().toISOString(),
                    options
                };
                
                try {
                    // Simulate screenshot request to server
                    const response = await fetch(`http://localhost:${this.config.jtagPort}/screenshot`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            filename: result.filename,
                            filepath: result.filepath,
                            options,
                            timestamp: result.timestamp
                        })
                    });
                    
                    if (response.ok) {
                        result.success = true;
                        result.metadata = {
                            width: options.width || window.innerWidth,
                            height: options.height || window.innerHeight,
                            size: 12345, // Simulated
                            selector: options.selector
                        };
                    }
                } catch (error) {
                    result.error = error.message;
                    result.success = false;
                }
                
                return result;
            },
            
            _sendToServer: async function(type, component, message, data) {
                try {
                    const entry = {
                        timestamp: new Date().toISOString(),
                        context: 'browser',
                        component,
                        message,
                        data,
                        type
                    };
                    
                    await fetch(`http://localhost:${this.config.jtagPort}/jtag`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(entry)
                    });
                    
                    this._updateStatus('success', 'üì° Connected to JTAG Server');
                } catch (error) {
                    this._updateStatus('error', 'üì° JTAG Server Unavailable');
                }
            },
            
            _logToConsole: function(emoji, component, message, data) {
                console.log(`üåê JTAG ${emoji} [${component}]: ${message}`, data || '');
            },
            
            _updateStatus: function(type, message) {
                const status = document.getElementById('status');
                status.className = `status ${type}`;
                status.textContent = message;
            },
            
            getStats: function() {
                return {
                    totalEntries: Math.floor(Math.random() * 100),
                    entriesByType: { log: 45, critical: 12, trace: 23, probe: 8 },
                    entriesByComponent: { BROWSER_TEST: 30, UI_TEST: 25, TRANSPORT_TEST: 33 }
                };
            }
        };

        /**
         * Test Functions
         */
        function testBasicLogging() {
            const output = document.getElementById('log-output');
            output.innerHTML = '';
            
            jtag.log('BROWSER_TEST', 'Testing basic logging from browser');
            jtag.log('BROWSER_TEST', 'User interaction detected', {
                element: 'button',
                action: 'click',
                timestamp: Date.now()
            });
            
            appendOutput('log-output', '‚úÖ Basic logging tests completed');
        }
        
        function testLogLevels() {
            const output = document.getElementById('log-output');
            
            jtag.log('LOG_LEVELS', 'Regular log message');
            jtag.critical('LOG_LEVELS', 'Critical browser event', { type: 'test' });
            jtag.trace('LOG_LEVELS', 'testFunction', 'ENTER', { params: ['test'] });
            jtag.trace('LOG_LEVELS', 'testFunction', 'EXIT', { result: 'success' });
            jtag.probe('LOG_LEVELS', 'dom_state', {
                elements: document.querySelectorAll('*').length,
                viewport: { width: window.innerWidth, height: window.innerHeight }
            });
            
            appendOutput('log-output', '‚úÖ All log levels tested');
        }
        
        function testConfiguration() {
            const output = document.getElementById('log-output');
            
            jtag.log('CONFIG_TEST', 'Showing browser JTAG configuration', jtag.config);
            
            appendOutput('log-output', '‚öôÔ∏è Configuration logged to server');
            appendOutput('log-output', `üîå Port: ${jtag.config.jtagPort}`);
            appendOutput('log-output', `üåê Context: ${jtag.config.context}`);
        }
        
        async function testScreenshotFull() {
            const output = document.getElementById('screenshot-output');
            output.innerHTML = 'Taking full page screenshot...';
            
            try {
                const result = await jtag.screenshot('browser-full-page');
                
                if (result.success) {
                    appendOutput('screenshot-output', `‚úÖ Screenshot saved: ${result.filepath}`);
                    appendOutput('screenshot-output', `üìè Size: ${result.metadata?.width}x${result.metadata?.height}`);
                } else {
                    appendOutput('screenshot-output', `‚ùå Screenshot failed: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                appendOutput('screenshot-output', `‚ùå Screenshot error: ${error.message}`);
            }
        }
        
        async function testScreenshotWidget() {
            const output = document.getElementById('screenshot-output');
            
            try {
                const result = await jtag.screenshot('test-widget-capture', {
                    selector: '#test-widget',
                    width: 350,
                    height: 200,
                    format: 'png'
                });
                
                if (result.success) {
                    appendOutput('screenshot-output', `‚úÖ Widget screenshot: ${result.filepath}`);
                    appendOutput('screenshot-output', `üéØ Selector: ${result.options.selector}`);
                } else {
                    appendOutput('screenshot-output', `‚ùå Widget screenshot failed: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                appendOutput('screenshot-output', `‚ùå Widget screenshot error: ${error.message}`);
            }
        }
        
        async function testScreenshotAsync() {
            const output = document.getElementById('screenshot-output');
            
            appendOutput('screenshot-output', 'üîÑ Testing async screenshot workflow...');
            
            // Fire and forget
            jtag.screenshot('fire-and-forget');
            appendOutput('screenshot-output', 'üì§ Fire-and-forget screenshot sent');
            
            // Async with await
            try {
                const result = await jtag.screenshot('async-test', { quality: 90 });
                appendOutput('screenshot-output', `üì• Async result: ${result.success ? 'SUCCESS' : 'FAILED'}`);
            } catch (error) {
                appendOutput('screenshot-output', `‚ùå Async error: ${error.message}`);
            }
        }
        
        async function testPayloadTransport() {
            const output = document.getElementById('transport-output');
            output.innerHTML = 'Testing base64 payload transport...';
            
            try {
                // Create fake image data
                const fakeImageData = btoa('FAKE_PNG_DATA_FOR_BROWSER_TEST');
                
                const response = await fetch(`http://localhost:${jtag.config.jtagPort}/payload`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'screenshot_data',
                        data: fakeImageData,
                        encoding: 'base64'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    appendOutput('transport-output', '‚úÖ Base64 transport successful');
                    appendOutput('transport-output', `üì¶ Payload processed: ${result.success}`);
                } else {
                    appendOutput('transport-output', `‚ùå Transport failed: ${response.status}`);
                }
            } catch (error) {
                appendOutput('transport-output', `‚ùå Transport error: ${error.message}`);
            }
        }
        
        async function testLogBatch() {
            const output = document.getElementById('transport-output');
            
            // Create batch of logs
            const logBatch = [
                { component: 'BATCH_TEST', message: 'Batch log 1', timestamp: new Date().toISOString() },
                { component: 'BATCH_TEST', message: 'Batch log 2', timestamp: new Date().toISOString() },
                { component: 'BATCH_TEST', message: 'Batch log 3', timestamp: new Date().toISOString() }
            ];
            
            try {
                const batchData = btoa(JSON.stringify(logBatch));
                
                const response = await fetch(`http://localhost:${jtag.config.jtagPort}/payload`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'log_batch',
                        data: batchData,
                        encoding: 'base64'
                    })
                });
                
                if (response.ok) {
                    appendOutput('transport-output', '‚úÖ Log batch transport successful');
                    appendOutput('transport-output', `üì¶ Batch size: ${logBatch.length} logs`);
                } else {
                    appendOutput('transport-output', `‚ùå Batch transport failed: ${response.status}`);
                }
            } catch (error) {
                appendOutput('transport-output', `‚ùå Batch transport error: ${error.message}`);
            }
        }
        
        async function testCustomPayload() {
            const output = document.getElementById('transport-output');
            
            const customData = {
                browserInfo: navigator.userAgent,
                viewport: { width: window.innerWidth, height: window.innerHeight },
                timestamp: new Date().toISOString(),
                testData: 'Custom payload from browser'
            };
            
            try {
                const encodedData = btoa(JSON.stringify(customData));
                
                const response = await fetch(`http://localhost:${jtag.config.jtagPort}/payload`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'custom_data',
                        data: encodedData,
                        encoding: 'base64'
                    })
                });
                
                if (response.ok) {
                    appendOutput('transport-output', '‚úÖ Custom payload transport successful');
                    appendOutput('transport-output', `üì¶ Data size: ${JSON.stringify(customData).length} chars`);
                } else {
                    appendOutput('transport-output', `‚ùå Custom payload failed: ${response.status}`);
                }
            } catch (error) {
                appendOutput('transport-output', `‚ùå Custom payload error: ${error.message}`);
            }
        }
        
        async function runFullIntegration() {
            const output = document.getElementById('integration-output');
            output.innerHTML = 'Running full integration test...';
            
            try {
                // Test all JTAG features in sequence
                jtag.log('INTEGRATION', 'Starting full integration test');
                
                await new Promise(resolve => setTimeout(resolve, 100));
                jtag.critical('INTEGRATION', 'Testing critical path');
                
                await new Promise(resolve => setTimeout(resolve, 100));
                jtag.trace('INTEGRATION', 'integrationTest', 'ENTER');
                
                const screenshot = await jtag.screenshot('integration-test');
                
                jtag.probe('INTEGRATION', 'test_results', {
                    screenshotSuccess: screenshot.success,
                    timestamp: Date.now()
                });
                
                jtag.trace('INTEGRATION', 'integrationTest', 'EXIT', { result: 'success' });
                
                appendOutput('integration-output', '‚úÖ Full integration test completed');
                appendOutput('integration-output', `üì∏ Screenshot: ${screenshot.success ? 'SUCCESS' : 'FAILED'}`);
                
            } catch (error) {
                appendOutput('integration-output', `‚ùå Integration test failed: ${error.message}`);
            }
        }
        
        function simulateError() {
            const output = document.getElementById('integration-output');
            
            try {
                jtag.trace('ERROR_SIM', 'riskyOperation', 'ENTER');
                
                // Simulate error condition
                throw new Error('Simulated application error for testing');
                
            } catch (error) {
                jtag.critical('ERROR_SIM', 'Application error occurred', {
                    error: error.message,
                    stack: error.stack,
                    context: 'simulateError function',
                    userAgent: navigator.userAgent,
                    timestamp: new Date().toISOString()
                });
                
                jtag.trace('ERROR_SIM', 'riskyOperation', 'EXIT', { result: 'error' });
                
                appendOutput('integration-output', '‚úÖ Error simulation completed');
                appendOutput('integration-output', `üí• Simulated error: ${error.message}`);
            }
        }
        
        function showStatistics() {
            const output = document.getElementById('integration-output');
            const stats = jtag.getStats();
            
            jtag.log('STATS', 'JTAG Statistics Report', stats);
            
            appendOutput('integration-output', 'üìä JTAG Statistics:');
            appendOutput('integration-output', `üìù Total entries: ${stats.totalEntries}`);
            appendOutput('integration-output', `üìà By type: ${JSON.stringify(stats.entriesByType)}`);
            appendOutput('integration-output', `üè∑Ô∏è By component: ${JSON.stringify(stats.entriesByComponent)}`);
        }
        
        function appendOutput(elementId, message) {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            element.scrollTop = element.scrollHeight;
        }

        // Initialize
        window.addEventListener('load', function() {
            console.log('üö® JTAG Browser Simulation loaded');
            jtag.log('BROWSER_INIT', 'JTAG browser simulation started', {
                userAgent: navigator.userAgent,
                viewport: { width: window.innerWidth, height: window.innerHeight }
            });
        });
    </script>
</body>
</html>