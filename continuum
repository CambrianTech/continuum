#!/bin/bash
# Continuum CLI - Thin client that connects to daemon system

# Get command from argument (default to connect)
COMMAND="${1:-connect}"

# Function to check if daemon is running
daemon_running() {
  curl -s http://localhost:9000/api/health > /dev/null 2>&1
}

# Function to start daemon system
start_daemon() {
  # Find continuum installation - resolve relative to script location
  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  CONTINUUM_DIR="$SCRIPT_DIR"
  
  if [ ! -f "$CONTINUUM_DIR/main.ts" ]; then
    echo "âŒ Continuum installation not found at $CONTINUUM_DIR"
    exit 1
  fi
  
  echo "ðŸš€ Starting Continuum daemon system..."
  cd "$CONTINUUM_DIR" && nohup tsx main.ts > /dev/null 2>&1 &
  
  # Wait for daemon OS to be ready
  for i in {1..30}; do
    if daemon_running; then
      echo "âœ… Daemon system started"
      return 0
    fi
    sleep 1
  done
  
  echo "âŒ Failed to start daemon system"
  return 1
}

# Function to stop daemon system
stop_daemon() {
  echo "ðŸ›‘ Stopping Continuum daemon system..."
  pkill -f "tsx main.ts" 2>/dev/null || true
  sleep 2
  echo "âœ… Daemon system stopped"
}

# Handle explicit daemon management commands 
case "$COMMAND" in
  "start")
    if daemon_running; then
      echo "âœ… Continuum daemons already running at http://localhost:9000"
    else
      start_daemon
    fi
    exit 0
    ;;
  "stop")
    if daemon_running; then
      stop_daemon
    else
      echo "âœ… Continuum daemons already stopped"
    fi
    exit 0
    ;;
  "restart")
    if daemon_running; then
      stop_daemon
    fi
    start_daemon
    exit 0
    ;;
esac

# For all other commands (including connect), ensure daemon is running and call via API
if ! daemon_running; then
  echo "ðŸš€ Auto-starting Continuum daemon system..."
  start_daemon || exit 1
fi

# Call command via API
curl -s -X POST "http://localhost:9000/api/commands/$COMMAND" \
  -H "Content-Type: application/json" \
  -d '{"args": []}'