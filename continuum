#!/bin/bash
# Continuum CLI - Connects to daemon system

# Connection function that starts daemon manager if needed
connect() {
    # Check if main daemon is running
    if ! curl -s http://localhost:9000/api/health > /dev/null 2>&1; then
        echo "üöÄ Starting Continuum daemon manager..."
        
        # Find continuum installation
        local continuum_dir="/Volumes/FlashGordon/cambrian/continuum"
        if [ ! -f "$continuum_dir/main.ts" ]; then
            echo "‚ùå Could not find Continuum installation at $continuum_dir"
            exit 1
        fi
        
        # Start the main daemon (which manages all other daemons)
        cd "$continuum_dir"
        nohup tsx main.ts > /dev/null 2>&1 &
        local pid=$!
        echo "‚úÖ Started daemon manager (PID: $pid)"
        
        # Wait for it to be ready
        echo "‚è≥ Waiting for daemons to start..."
        for i in {1..30}; do
            if curl -s http://localhost:9000/api/health > /dev/null 2>&1; then
                echo "‚úÖ Continuum daemons ready"
                break
            fi
            sleep 1
        done
    fi
}

# Main command handler
case "$1" in
    "")
        # No args - connect and open browser
        connect
        open http://localhost:9000 2>/dev/null || echo "üåê Open http://localhost:9000"
        ;;
    stop)
        # Stop all daemons
        echo "üõë Stopping Continuum daemons..."
        curl -X POST http://localhost:9000/api/shutdown 2>/dev/null || pkill -f "tsx.*main.ts"
        echo "‚úÖ Daemons stopped"
        ;;
    restart)
        # Restart daemons
        echo "üîÑ Restarting Continuum daemons..."
        # Stop
        curl -X POST http://localhost:9000/api/shutdown 2>/dev/null || pkill -f "tsx.*main.ts"
        sleep 1
        # Start
        connect
        ;;
    status)
        # Check daemon status
        if curl -s http://localhost:9000/api/health > /dev/null 2>&1; then
            echo "‚úÖ Continuum daemons running"
            curl -s http://localhost:9000/api/status | jq . 2>/dev/null || curl -s http://localhost:9000/api/status
        else
            echo "‚ùå Continuum daemons not running"
        fi
        ;;
    logs)
        # Show daemon logs
        connect
        # Subscribe to log stream via WebSocket
        echo "üìã Connecting to daemon logs..."
        echo "Press CTRL+C to disconnect"
        wscat -c ws://localhost:9000 -x '{"type":"subscribe","events":["log"]}'
        ;;
    *)
        # Execute command via daemon system
        connect
        # Build args array for JSON
        args_json=""
        for arg in "${@:2}"; do
            if [ -n "$args_json" ]; then
                args_json="$args_json,"
            fi
            # Escape quotes in arg
            escaped_arg=$(echo "$arg" | sed 's/"/\\"/g')
            args_json="$args_json\"$escaped_arg\""
        done
        
        # Send command to daemon system
        response=$(curl -s -X POST http://localhost:9000/api/commands/$1 \
            -H "Content-Type: application/json" \
            -d "{\"args\":[$args_json]}")
        
        if [ $? -eq 0 ]; then
            # Extract the result from the response
            result=$(echo "$response" | jq -r '.data.result // .result // .output // .data // .' 2>/dev/null)
            if [ "$result" != "null" ] && [ -n "$result" ]; then
                echo "$result" | jq . 2>/dev/null || echo "$result"
            else
                echo "$response"
            fi
        else
            echo "‚ùå Command failed"
            exit 1
        fi
        ;;
esac