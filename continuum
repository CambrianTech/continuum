#!/bin/bash

echo "THIS IS THE LEGACY SYSTEM. cd to src/debug/jtag IMMEDIATELY!";

# Continuum CLI - Universal thin client that pipes to TypeScript handler
# Much simpler: just handle daemon management and pipe everything else to TS

# Handle special daemon management commands that need bash
case "$1" in
  "start"|"stop"|"restart"|"status"|"version"|"--version"|"-v")
    # Only daemon management commands stay in bash
    ;;
  "")
    # Empty command - default to connect
    set -- "connect" "$@"
    ;;
  *)
    # Everything else goes to TypeScript CLI - no special cases
    npx tsx src/cli/continuum-cli.ts "$@"
    exit $?
    ;;
esac

# Function to check if daemon is running
daemon_running() {
  curl -s http://localhost:9000/api/health > /dev/null 2>&1
}

# Function to find continuum installation
find_continuum_installation() {
  # Priority order for finding continuum installation:
  # 1. Current directory (development mode)
  # 2. Script directory (local installation)
  # 3. Homebrew installation
  # 4. npm global installation
  # 5. Common system paths
  
  local candidates=(
    "$(pwd)"                                    # Current directory (development)
    "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"  # Script location
    "/opt/homebrew/lib/node_modules/continuum"  # Homebrew installation
    "/usr/local/lib/node_modules/continuum"     # npm global (Intel Mac)
    "/opt/homebrew/bin/continuum"               # Homebrew binary path
    "/usr/local/bin/continuum"                  # System binary path
    "$HOME/.npm-global/lib/node_modules/continuum"  # User npm global
    "$HOME/continuum"                           # User local installation
  )
  
  for dir in "${candidates[@]}"; do
    if [ -d "$dir" ] && ([ -f "$dir/package.json" ] || [ -f "$dir/main.ts" ] || [ -f "$dir/launch.ts" ]); then
      echo "$dir"
      return 0
    fi
  done
  
  return 1
}

# Function to start daemon system
start_daemon() {
  echo "üîç Searching for Continuum installation..."
  
  local install_dir
  install_dir=$(find_continuum_installation)
  
  if [ $? -ne 0 ] || [ -z "$install_dir" ]; then
    echo "‚ùå Continuum installation not found"
    echo "   Searched common installation paths:"
    echo "   - Current directory: $(pwd)"
    echo "   - Script directory: $(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    echo "   - Homebrew: /opt/homebrew/lib/node_modules/continuum"
    echo "   - npm global: /usr/local/lib/node_modules/continuum"
    echo "   - User paths: ~/.npm-global/lib/node_modules/continuum"
    echo ""
    echo "üí° Install options:"
    echo "   npm install -g continuum     # Global installation"
    echo "   brew install continuum       # Homebrew installation"
    echo "   git clone <repo> && cd continuum && npm install  # Development"
    exit 1
  fi
  
  echo "‚úÖ Found Continuum at: $install_dir"
  cd "$install_dir" || exit 1
  
  # Determine best start method based on what's available
  if [ -f "main.ts" ] && command -v tsx > /dev/null 2>&1; then
    echo "üöÄ Starting Continuum daemon system (TypeScript)..."
    nohup tsx main.ts > /dev/null 2>&1 &
  elif [ -f "launch.ts" ] && command -v npm > /dev/null 2>&1; then
    echo "üöÄ Starting Continuum daemon system (development mode)..."
    nohup npm run dev > /dev/null 2>&1 &
  elif [ -f "package.json" ] && command -v npm > /dev/null 2>&1; then
    # Check if npm start would cause circular dependency (calling ./continuum)
    if npm run | grep -q "start"; then
      # Check if npm start contains reference to ./continuum
      if npm run start 2>/dev/null | grep -q "./continuum"; then
        echo "‚ùå CIRCULAR DEPENDENCY DETECTED!"
        echo "   npm start calls ./continuum but main.ts is missing"
        echo "   This would create an infinite loop"
        echo "   Please restore main.ts or fix the npm start script"
        exit 1
      fi
      echo "üöÄ Starting Continuum daemon system (npm)..."
      nohup npm start > /dev/null 2>&1 &
    else
      nohup npm run dev > /dev/null 2>&1 &
    fi
  elif [ -f "dist/main.js" ] && command -v node > /dev/null 2>&1; then
    echo "üöÄ Starting Continuum daemon system (compiled)..."
    nohup node dist/main.js > /dev/null 2>&1 &
  else
    echo "‚ùå No suitable start method found"
    echo "   Available files:"
    ls -la main.* launch.* package.json dist/main.* 2>/dev/null || echo "   None found"
    echo "   Available commands:"
    echo "   - tsx: $(command -v tsx || echo 'not found')"
    echo "   - npm: $(command -v npm || echo 'not found')"
    echo "   - node: $(command -v node || echo 'not found')"
    exit 1
  fi
  
  # Wait for daemon OS to be ready with better feedback
  echo "‚è≥ Waiting for daemon system to start..."
  for i in {1..30}; do
    if daemon_running; then
      echo "‚úÖ Daemon system started and responding at http://localhost:9000"
      return 0
    fi
    printf "."
    sleep 1
  done
  
  echo ""
  echo "‚ùå Failed to start daemon system (timeout after 30 seconds)"
  echo "   Check if port 9000 is available:"
  lsof -i :9000 2>/dev/null || echo "   Port 9000 appears to be free"
  return 1
}

# Function to stop daemon system
stop_daemon() {
  echo "üõë Stopping Continuum daemon system..."
  
  # Try graceful shutdown via API first
  if daemon_running; then
    echo "   Attempting graceful shutdown..."
    curl -s -X POST "http://localhost:9000/api/commands/shutdown" \
      -H "Content-Type: application/json" \
      -d '{"args": []}' > /dev/null 2>&1 || true
    sleep 3
  fi
  
  # Force kill if still running
  if daemon_running; then
    echo "   Force stopping processes..."
    # Kill various possible process patterns
    pkill -f "tsx main.ts" 2>/dev/null || true
    pkill -f "tsx launch.ts" 2>/dev/null || true  
    pkill -f "npm run dev" 2>/dev/null || true
    pkill -f "npm start" 2>/dev/null || true
    pkill -f "node.*continuum" 2>/dev/null || true
    
    # Kill processes using port 9000
    lsof -ti:9000 2>/dev/null | xargs kill -9 2>/dev/null || true
    sleep 2
  fi
  
  if daemon_running; then
    echo "‚ö†Ô∏è  Daemon may still be running - check manually with: lsof -i :9000"
  else
    echo "‚úÖ Daemon system stopped"
  fi
}

# Function to get system status
status_daemon() {
  if daemon_running; then
    echo "‚úÖ Continuum daemon system is running at http://localhost:9000"
    echo "üìä System status:"
    curl -s "http://localhost:9000/api/status" 2>/dev/null | head -20 || echo "   Unable to fetch detailed status"
  else
    echo "‚ùå Continuum daemon system is not running"
    echo "üîç Checking for zombie processes on port 9000:"
    lsof -i :9000 2>/dev/null || echo "   No processes found on port 9000"
  fi
}

# Handle version
if [ "$1" = "--version" ] || [ "$1" = "-v" ] || [ "$1" = "version" ]; then
  # Check if daemon is running
  if daemon_running; then
    # Get version from API
    VERSION=$(curl -s "http://localhost:9000/api/version" 2>/dev/null | grep -o '"version":"[^"]*"' | cut -d'"' -f4)
    if [ -n "$VERSION" ]; then
      echo "continuum $VERSION"
      exit 0
    fi
  fi
  
  # Fallback to local package.json
  install_dir=$(find_continuum_installation)
  if [ -n "$install_dir" ] && [ -f "$install_dir/package.json" ]; then
    VERSION=$(grep '"version"' "$install_dir/package.json" | head -1 | cut -d'"' -f4)
  else
    VERSION="unknown"
  fi
  echo "continuum $VERSION"
  exit 0
fi

# Handle explicit daemon management commands 
case "$1" in
  "start")
    if daemon_running; then
      echo "‚úÖ Continuum daemons already running at http://localhost:9000"
    else
      start_daemon
    fi
    exit 0
    ;;
  "stop")
    if daemon_running; then
      stop_daemon
    else
      echo "‚úÖ Continuum daemons already stopped"
    fi
    exit 0
    ;;
  "restart")
    if daemon_running; then
      stop_daemon
    fi
    start_daemon
    exit 0
    ;;
  "status")
    status_daemon
    exit 0
    ;;
  "")
    # Empty command - default to connect
    set -- "connect" "$@"
    ;;
  "help"|"--help"|"-h")
    ;;
esac

# For all other commands (including connect), ensure daemon is running and call via API
if ! daemon_running; then
  echo "üöÄ Auto-starting Continuum daemon system..."
  start_daemon || exit 1
fi

# Session parameters handled by TypeScript CLI - no bash JSON building needed

# Universal command handling - ALL commands go through TypeScript CLI
# No special cases, no god objects, pure ultra-thin delegation
npx tsx src/cli/continuum-cli.ts "$@"