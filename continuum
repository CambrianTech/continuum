#!/usr/bin/env node
/**
 * Continuum CLI - Clean TypeScript System Launcher
 * Simple wrapper around the TypeScript daemon system
 */

import { spawn } from 'child_process';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Parse simple command line arguments
const args = process.argv.slice(2);
const command = args[0] || 'start';

// Get package version
function getVersion() {
  try {
    const packagePath = path.join(__dirname, 'package.json');
    const packageJson = JSON.parse(fs.readFileSync(packagePath, 'utf8'));
    return packageJson.version;
  } catch (error) {
    return 'unknown';
  }
}

// Show help
function showHelp() {
  console.log(`
üåê Continuum v${getVersion()} - Like Docker Desktop for AI Collaboration

USAGE:
  continuum                    Start service + browser interface
  continuum start              Start the service (explicit)
  continuum stop               Stop the running service
  continuum restart            Restart the service
  continuum status             Show service status
  continuum browser            Ensure browser interface is up
  continuum devtools           Enhanced mode for AI agents
  continuum --version          Show version
  continuum --help             Show this help

SERVICE:
  üê≥ Like Docker Desktop - Simple persistent service
  üåê Browser Interface - Primary UI at localhost:9000  
  üîå WebSocket API - Universal connection point for AIs/humans
  üõ†Ô∏è DevTools Ready - Built-in debugging protocol

The browser is your PRIMARY interface - opens automatically.
AIs connect via WebSocket. Simple and clean.
`);
}

// Import and use Continuum core
async function importContinuum() {
  try {
    const ContinuumModule = await import('./src/core/Continuum.js');
    return ContinuumModule.default;
  } catch (error) {
    console.error('‚ùå Failed to import Continuum core:', error);
    process.exit(1);
  }
}

// Main CLI handler
async function main() {
  const Continuum = await importContinuum();
  const continuum = new Continuum();

  switch (command) {
    case 'help':
    case '--help':
    case '-h':
      showHelp();
      break;
      
    case 'version':
    case '--version':
    case '-v':
      console.log(`continuum v${getVersion()}`);
      break;
      
    case 'status':
      const status = await continuum.status();
      console.log('üìä Continuum System Status');
      console.log('='.repeat(30));
      if (status.running) {
        console.log('üü¢ Status: RUNNING');
        console.log(`üåê Interface: ${status.interface}`);
        console.log(`üîå API: ${status.api}`);
      } else {
        console.log('üî¥ Status: STOPPED');
        console.log(status.message);
      }
      break;
      
    case 'stop':
      await continuum.stop();
      break;
      
    case 'restart':
      console.log('üîÑ Restarting Continuum system...');
      await continuum.stop();
      setTimeout(async () => {
        await continuum.init();
        continuum.keepAlive();
      }, 2000);
      break;
      
    case 'connect':
      await continuum.connect();
      break;
      
    case 'devtools':
      await continuum.init({ devtools: true });
      continuum.keepAlive();
      break;
      
    case 'start':
    default:
      // Default action: connect to existing or start new
      await continuum.connect();
      continuum.keepAlive();
      break;
  }
}

// Handle graceful shutdown
process.on('SIGINT', () => {
  console.log('\nüõë Shutting down...');
  process.exit(0);
});

process.on('SIGTERM', () => {
  console.log('\nüõë Terminating...');
  process.exit(0);
});

main().catch(error => {
  console.error('‚ùå CLI error:', error);
  process.exit(1);
});