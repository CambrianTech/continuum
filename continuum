#!/bin/bash
# Continuum CLI - Works for both repo users and npm global installs

find_continuum_dir() {
    # Method 1: Check if we're in a continuum repo
    local current_dir="$PWD"
    while [ "$current_dir" != "/" ]; do
        if [ -f "$current_dir/package.json" ] && grep -q '"name": "continuum"' "$current_dir/package.json" 2>/dev/null; then
            echo "$current_dir"
            return 0
        fi
        current_dir="$(dirname "$current_dir")"
    done
    
    # Method 2: Resolve script location (for npm global install)
    local script_path="$0"
    if [ -L "$script_path" ]; then
        script_path="$(readlink "$script_path")"
        # For npm global installs, the actual path might be relative to the symlink
        if [[ "$script_path" == "../"* ]]; then
            local symlink_dir="$(dirname "$0")"
            local target_dir="$(dirname "$script_path")"
            local target_file="$(basename "$script_path")"
            script_path="$(cd "$symlink_dir" && cd "$target_dir" && pwd)/$target_file" 2>/dev/null || script_path="$0"
        fi
    fi
    local script_dir="$(dirname "$script_path")"
    if [ -f "$script_dir/package.json" ] && grep -q '"name": "continuum"' "$script_dir/package.json" 2>/dev/null; then
        echo "$script_dir"
        return 0
    fi
    
    # Method 2b: Check npm global module path
    local npm_global_root="$(npm root -g 2>/dev/null)/continuum"
    if [ -f "$npm_global_root/package.json" ] && grep -q '"name": "continuum"' "$npm_global_root/package.json" 2>/dev/null; then
        echo "$npm_global_root"
        return 0
    fi
    
    # Method 3: Check common locations
    local home_continuum="$HOME/continuum"
    if [ -f "$home_continuum/package.json" ] && grep -q '"name": "continuum"' "$home_continuum/package.json" 2>/dev/null; then
        echo "$home_continuum"
        return 0
    fi
    
    return 1
}

CONTINUUM_DIR="$(find_continuum_dir)"
if [ -z "$CONTINUUM_DIR" ]; then
    echo "âŒ Could not find continuum installation"
    echo "Make sure you're in a continuum repo or have continuum installed globally"
    exit 1
fi

# Found continuum directory, check if recompilation needed
echo "ğŸš€ Starting Continuum from: $CONTINUUM_DIR"
cd "$CONTINUUM_DIR"

# Check if TypeScript compilation is needed
if [ -f "tsconfig.json" ] && command -v npx >/dev/null 2>&1; then
    echo "ğŸ”§ Checking TypeScript compilation..."
    if ! npx tsc --noEmit --project . >/dev/null 2>&1; then
        echo "âš ï¸  TypeScript compilation issues detected"
        echo "ğŸ”§ Running: npx tsc --noEmit --project . to check errors"
        npx tsc --noEmit --project .
        echo ""
        echo "ğŸ’¡ You may want to fix compilation errors before running"
        echo "ğŸš€ Continuing with launch anyway..."
    else
        echo "âœ… TypeScript compilation clean"
    fi
fi

# Check if continuum is already running
EXISTING_PID=$(pgrep -f "tsx.*launch.ts" | head -1)

if [ ! -z "$EXISTING_PID" ]; then
    echo "âœ… Continuum is already running (PID: $EXISTING_PID)"
    
    # If no arguments, just focus existing tab
    if [ $# -eq 0 ]; then
        # Try to focus existing tab
        if command -v osascript >/dev/null 2>&1; then
            osascript -e 'tell application "Opera GX" to activate' 2>/dev/null || \
            osascript -e 'tell application "Opera" to activate' 2>/dev/null || \
            osascript -e 'tell application "Google Chrome" to activate' 2>/dev/null || \
            osascript -e 'tell application "Safari" to activate' 2>/dev/null
        fi
        open http://localhost:9000 2>/dev/null || echo "ğŸŒ Open http://localhost:9000 in your browser"
        exit 0
    else
        # Pass commands to running instance
        echo "ğŸ“¡ Sending command to running instance..."
        npm run "$@"
        exit $?
    fi
fi

# Not running, start it
npm run launch