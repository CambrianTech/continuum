#!/usr/bin/env sh
# CONTINUUM PRE-PUSH VALIDATION: PREVENT REGRESSIONS ONLY
# Focus on blocking breaking changes, not comprehensive testing

npm run log:git-hook pre-push >/dev/null 2>&1 || true
printf "\rContinuum Pre-Push: Preventing Regressions\n" >&2
echo "ðŸ›¡ï¸ Blocking breaking changes - Pre-commit already validated code quality"
echo ""

# ðŸŽ“ CRITICAL: Graduated modules must never regress
echo "ðŸŽ“ Graduated module regression check..."
npm run test:quality:push --silent || {
    echo ""
    echo "âŒ PUSH BLOCKED: Graduated module regression detected!"
    echo "   ðŸ” Run: npm run test:quality:push"
    echo "   ðŸ’¡ Graduated modules must maintain perfect quality forever"
    echo "   ðŸŽ¯ Either fix the regression or demote the module status"
    exit 1
}
echo "   âœ… No regressions in graduated modules"

# ðŸ”Œ CRITICAL: Core integration must not be broken
echo "ðŸ”Œ Core integration stability check..."
npm run test:integration:layer2-3 --silent || {
    echo ""
    echo "âŒ PUSH BLOCKED: Core integration broken!"
    echo "   ðŸ” Run: npm run test:integration:layer2-3"
    echo "   ðŸ’¡ Core daemons and commands must integrate properly"
    echo "   ðŸŽ¯ Fix integration failures before pushing"
    exit 1
}
echo "   âœ… Core integration stable"

# ðŸ“Š CRITICAL: Quality Ratchet - No Degradation Ever
echo "ðŸ“Š Quality Ratchet: Enforcing monotonic quality improvement..."

# Get current quality score
CURRENT_SCORE=$(npx tsx src/testing/ModuleComplianceReport.ts --use-whitelist --silent 2>/dev/null | grep "âœ… Compliant:" | sed 's/.*(\([0-9.]*\)%).*/\1/' || echo "0")

# Check for graduated module regressions (stricter than basic compliance)
if ! npx tsx src/testing/QualityEnforcementEngine.ts --push --silent >/dev/null 2>&1; then
    echo ""
    echo "âŒ PUSH BLOCKED: Quality degradation detected!"
    echo "   ðŸŽ¯ Core Principle Violated: qualityScore(after) >= qualityScore(before)"
    echo "   ðŸ” Run: npm run test:quality:push"
    echo "   ðŸ’¡ Graduated modules can NEVER regress in quality"
    echo "   ðŸŽ“ Either fix the degradation or demote module status"
    exit 1
fi

# Ensure module compliance violations don't break existing modules
npx tsx src/testing/ModuleComplianceReport.ts --exit-on-failure --use-whitelist --silent || {
    echo ""
    echo "âŒ PUSH BLOCKED: Module compliance violations!"
    echo "   ðŸ” Run: npm run test:compliance:strict"
    echo "   ðŸ’¡ Module structure changes broke compliance"
    echo "   ðŸŽ¯ Fix module structure or update whitelist"
    exit 1
}

echo "   âœ… Quality ratchet enforced - no degradation detected"
echo "   ðŸ“Š Current compliance: ${CURRENT_SCORE}%"

# âœ… ALL CRITICAL PROTECTIONS PASSED
echo ""
echo "âœ… QUALITY RATCHET ENFORCEMENT COMPLETE!"
echo "ðŸŽ¯ Core Principle: qualityScore(after) >= qualityScore(before) âœ…"
echo "ðŸŽ“ Graduated modules maintain perfect quality"
echo "ðŸ”Œ Core integration remains stable"
echo "ðŸ“Š Module compliance: ${CURRENT_SCORE}% maintained"
echo ""
echo "ðŸš€ SAFE TO PUSH - NO QUALITY DEGRADATION!"
echo ""
echo "ðŸ’¡ MIDDLE-OUT PHASE 1 IMPLEMENTATION:"
echo "   â€¢ Pre-commit: 6-layer validation + JTAG health check âœ…"
echo "   â€¢ Pre-push: Quality ratchet + regression prevention âœ…"
echo "   â€¢ Next: Phase 2 PR-level CI enforcement"
echo ""
echo "ðŸŽ“ GRADUATION OPPORTUNITY:"
echo "   â€¢ Run 'npm run test:compliance:graduation' to find promotion candidates"
echo "   â€¢ Quality improvements welcome - degradations blocked"
echo ""