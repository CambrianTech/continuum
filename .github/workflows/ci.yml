name: Continuum CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: src/debug/jtag

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: src/debug/jtag/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: TypeScript compilation
      run: |
        npm run build:ts
        echo "✅ TypeScript compilation passed"

    # Skip full tests for documentation-only PRs
    - name: Check if documentation-only PR
      id: check_pr
      working-directory: .
      run: |
        if git diff --name-only origin/main..HEAD | grep -qvE '\.(md|txt|yml|yaml)$'; then
          echo "skip_tests=false" >> $GITHUB_OUTPUT
        else
          echo "skip_tests=true" >> $GITHUB_OUTPUT
        fi

    - name: Run tests
      if: steps.check_pr.outputs.skip_tests != 'true'
      run: |
        npm run test:crud
        echo "✅ CRUD tests passed"

    - name: Validation complete
      run: echo "✅ CI validation complete - local precommit hook validates full system"