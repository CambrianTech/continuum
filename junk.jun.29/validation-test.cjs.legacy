/**
 * Essential Validation Test
 * Focused test to verify error handling and validation works correctly
 */

const assert = require('assert');
const fs = require('fs');
const path = require('path');
const os = require('os');

console.log('ğŸ§ª Running Essential Validation Tests');
console.log('=' .repeat(40));

// Test 1: BaseCommand Parameter Validation
console.log('ğŸ” Testing BaseCommand parameter validation...');

const BaseCommand = require('../BaseCommand.cjs');

// Test valid parameter parsing
try {
  const validParams = BaseCommand.parseParams('{"test": "value"}');
  assert(validParams.test === 'value', 'Should parse JSON parameters correctly');
  console.log('âœ… Valid parameter parsing works');
} catch (error) {
  console.log('âŒ Valid parameter parsing failed:', error.message);
}

// Test invalid parameter parsing
try {
  BaseCommand.parseParams('invalid-json');
  console.log('âŒ Invalid parameter parsing should have failed');
} catch (error) {
  if (error.message.includes('Invalid parameters')) {
    console.log('âœ… Invalid parameter parsing correctly handled');
  } else {
    console.log('âŒ Wrong error message for invalid params:', error.message);
  }
}

// Test parameter validation with schema
try {
  const definition = {
    parameters: {
      required_param: { required: true, type: 'string' },
      optional_param: { required: false, type: 'number' }
    }
  };
  
  // Valid parameters
  const validResult = BaseCommand.validateParams({ required_param: 'test' }, definition);
  assert(validResult.valid === true, 'Should pass validation for valid params');
  
  // Invalid parameters (missing required)
  const invalidResult = BaseCommand.validateParams({}, definition);
  assert(invalidResult.valid === false, 'Should fail validation for missing required params');
  assert(invalidResult.errors.length > 0, 'Should provide validation errors');
  
  console.log('âœ… Parameter validation schema works correctly');
} catch (error) {
  console.log('âŒ Parameter validation failed:', error.message);
}

// Test 2: CommandRegistry Error Handling
console.log('\nğŸ” Testing CommandRegistry error handling...');

const CommandRegistry = require('../CommandRegistry.cjs');

try {
  const registry = new CommandRegistry();
  
  // Test command execution with invalid command
  registry.executeCommand('INVALID_COMMAND', {}, null).then(result => {
    if (result.success === false && result.error.includes('not found')) {
      console.log('âœ… CommandRegistry handles invalid commands correctly');
    } else {
      console.log('âŒ CommandRegistry should fail for invalid commands');
    }
  }).catch(error => {
    console.log('âŒ CommandRegistry threw unexpected error:', error.message);
  });
  
} catch (error) {
  console.log('âŒ CommandRegistry initialization failed:', error.message);
}

// Test 3: CreateRoomCommand Error Scenarios
console.log('\nğŸ” Testing CreateRoomCommand error handling...');

const CreateRoomCommand = require('../core/createroom/CreateRoomCommand.cjs');

// Test missing continuum context
CreateRoomCommand.execute('{"name": "Test"}', null).then(result => {
  if (result.success === false && result.message.includes('Continuum context required')) {
    console.log('âœ… CreateRoomCommand handles missing context correctly');
  } else {
    console.log('âŒ CreateRoomCommand should fail without context');
  }
}).catch(error => {
  console.log('âŒ CreateRoomCommand threw unexpected error:', error.message);
});

// Test invalid parameters
CreateRoomCommand.execute('invalid-json', {}).then(result => {
  if (result.success === false && result.message.includes('Invalid parameters')) {
    console.log('âœ… CreateRoomCommand handles invalid JSON correctly');
  } else {
    console.log('âŒ CreateRoomCommand should fail for invalid JSON');
  }
}).catch(error => {
  console.log('âŒ CreateRoomCommand threw unexpected error:', error.message);
});

// Test empty room name
CreateRoomCommand.execute('{"name": ""}', { dataDir: '/tmp' }).then(result => {
  if (result.success === false && result.message.includes('cannot be empty')) {
    console.log('âœ… CreateRoomCommand validates empty room names correctly');
  } else {
    console.log('âŒ CreateRoomCommand should fail for empty room names');
  }
}).catch(error => {
  console.log('âŒ CreateRoomCommand threw unexpected error:', error.message);
});

// Test 4: FluentAPI Error Handling  
console.log('\nğŸ” Testing FluentAPI error handling...');

const FluentAPI = require('../../modules/FluentAPI.cjs');

try {
  const registry = new CommandRegistry();
  const api = new FluentAPI(registry);
  
  // Test unknown method handling
  try {
    api.nonExistentMethod();
    console.log('âŒ FluentAPI should throw error for unknown methods');
  } catch (error) {
    if (error.message.includes('Unknown fluent method')) {
      console.log('âœ… FluentAPI handles unknown methods correctly');
    } else {
      console.log('âŒ Wrong error message for unknown method:', error.message);
    }
  }
  
  // Test empty pipeline execution
  api.execute().then(result => {
    console.log('âŒ FluentAPI should fail for empty pipeline');
  }).catch(error => {
    if (error.message.includes('No commands in pipeline')) {
      console.log('âœ… FluentAPI handles empty pipeline correctly');
    } else {
      console.log('âŒ Wrong error message for empty pipeline:', error.message);
    }
  });
  
} catch (error) {
  console.log('âŒ FluentAPI initialization failed:', error.message);
}

// Test 5: File System Error Resilience
console.log('\nğŸ” Testing file system error resilience...');

// Create temp directory for testing
const testDataDir = fs.mkdtempSync(path.join(os.tmpdir(), 'continuum-test-'));
const mockContinuum = {
  dataDir: testDataDir,
  userId: 'test-user',
  username: 'TestUser'
};

// Create rooms directory
const roomsDir = path.join(testDataDir, 'rooms');
fs.mkdirSync(roomsDir, { recursive: true });

// Make directory read-only to simulate permission error
fs.chmodSync(roomsDir, 0o444);

CreateRoomCommand.execute(JSON.stringify({
  name: 'Permission Test Room'
}), mockContinuum).then(result => {
  if (result.success === false && result.message.includes('Failed to create room')) {
    console.log('âœ… Commands handle file system errors gracefully');
  } else {
    console.log('âŒ Commands should fail gracefully for permission errors');
  }
  
  // Cleanup
  fs.chmodSync(roomsDir, 0o755);
  fs.rmSync(testDataDir, { recursive: true, force: true });
  
}).catch(error => {
  console.log('âŒ File system error test failed:', error.message);
  // Cleanup
  fs.chmodSync(roomsDir, 0o755);
  fs.rmSync(testDataDir, { recursive: true, force: true });
});

console.log('\nâœ… Essential validation tests completed!');
console.log('ğŸ¯ Key error handling and validation mechanisms verified');